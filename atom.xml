<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Anarckk&#39;s Blog</title>
  
  
  <link href="https://anarckk.github.io/atom.xml" rel="self"/>
  
  <link href="https://anarckk.github.io/"/>
  <updated>2023-08-25T08:39:36.000Z</updated>
  <id>https://anarckk.github.io/</id>
  
  <author>
    <name>Anarckk</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>在Go语言中从零开始构建一个BitTorrent客户端</title>
    <link href="https://anarckk.github.io/2023/08/25/2023-08/[%E7%BF%BB%E8%AF%91]%E5%9C%A8Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AABitTorrent%E5%AE%A2%E6%88%B7%E7%AB%AF/"/>
    <id>https://anarckk.github.io/2023/08/25/2023-08/[%E7%BF%BB%E8%AF%91]%E5%9C%A8Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AABitTorrent%E5%AE%A2%E6%88%B7%E7%AB%AF/</id>
    <published>2023-08-25T10:00:00.000Z</published>
    <updated>2023-08-25T08:39:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>最近看到一个项目 <a href="https://github.com/codecrafters-io/build-your-own-x">build-your-own-x</a>, 一直以来都有使用qbittorrent, bitcomet这样的种子软件,但是一直没有学它的底层原理,所以,想借助这篇文章,一边翻译一边学习.最终搞出一个自己的种子下载器.</p><h2 id="Building-a-BitTorrent-client-from-the-ground-up-in-Go"><a href="#Building-a-BitTorrent-client-from-the-ground-up-in-Go" class="headerlink" title="Building a BitTorrent client from the ground up in Go"></a><a href="https://blog.jse.li/posts/torrent/">Building a BitTorrent client from the ground up in Go</a></h2><blockquote><p>What is the complete path between visiting thepiratebay and sublimating an mp3 file from thin air? In this post, we’ll implement enough of the BitTorrent protocol to download Debian. Look at the Source code or skip to the last bit.</p></blockquote><p>访问 Thepiratebay 和凭空生成 mp3 文件之间的完整路径是什么？在本篇文章中，我们将使用 BitTorrent 协议下载 Debian。查看源代码或跳到最后一点。</p><blockquote><p>This post is also available in Russian, Korean, and Chinese.</p></blockquote><p>本文章还有俄语、韩语和汉语版本。</p><blockquote><p>BitTorrent is a protocol for downloading and distributing files across the Internet. In contrast with the traditional client&#x2F;server relationship, in which downloaders connect to a central server (for example: watching a movie on Netflix, or loading the web page you’re reading now), participants in the BitTorrent network, called peers, download pieces of files from each other—<strong>this is what makes it a peer-to-peer protocol</strong>. We’ll investigate how this works, and build our own client that can find peers and exchange data between them.</p></blockquote><p>BitTorrent是一个在互联网中下载和分发文件的协议。和传统的客户端&#x2F;服务器关系相比，这样的关系中下载者连接到中央服务器（比如：在 Netflix 看一部电影，或者加载一个网页正如你现在在读的），在 BitTorrent 网络中的参与者，称之为 peers, 他们从互相之间下载文件片段，<strong>这就是点对点协议的特点。</strong> 我们将研究其工作原理，并建立自己的客户端，以便找到对等设备并在它们之间交换数据。</p><p><img src="https://anarckk.github.io/mypico/img/client-server-p2p.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/client-server-p2p.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="client-server-p2p"></p><blockquote><p>The protocol evolved organically over the past 20 years, and various people and organizations added extensions for features like encryption, private torrents, and new ways of finding peers. We’ll be implementing the original spec from 2001 to keep this a weekend-sized project.</p></blockquote><p>在过去的20年中，这一协议在自然演化中逐步发展，不同的个人和组织为其增加了诸如加密、私密种子和新的节点发现方式等功能的扩展。为了确保这个项目能在一个周末内完成，我们将采用2001年的原始规范进行实现。</p><blockquote><p>I’ll be using a Debian ISO file as my guinea pig because it’s big, but not huge, at 350MB. As a popular Linux distribution, there will be lots of fast and cooperative peers for us to connect to. And we’ll avoid the legal and ethical issues related to downloading pirated content.</p></blockquote><p>我将使用Debian的ISO文件作为实验对象，因为它的大小适中，只有350MB。作为一种受欢迎的Linux发行版，我们将能够连接到许多快速而合作的节点。同时，我们也将避免与下载盗版内容相关的法律和道德问题。</p><h2 id="Finding-peers"><a href="#Finding-peers" class="headerlink" title="Finding peers"></a>Finding peers</h2><blockquote><p>Here’s a problem: we want to download a file with BitTorrent, but it’s a peer-to-peer protocol and we have no idea where to find peers to download it from. This is a lot like moving to a new city and trying to make friends—maybe we’ll hit up a local pub or a meetup group! Centralized locations like these are the big idea behind trackers, which are central servers that introduce peers to each other. They’re just web servers running over HTTP* , and you can find Debian’s at <a href="http://bttracker.debian.org:6969/">http://bttracker.debian.org:6969/</a></p></blockquote><p>这里有一个问题：我们想使用 BitTorrent 下载一个文件，但它是一种点对点协议，我们不知道从哪里找到其他用户来下载。这就像搬到一个新城市并试图交朋友一样——也许我们会去当地的酒吧或聚会！这些集中的地点是跟踪器背后的大思想，它们是引导用户相互认识的中央服务器。它们只是运行在 HTTP 上的 Web 服务器，你可以在 <a href="http://bttracker.debian.org:6969/">http://bttracker.debian.org:6969/</a> 找到 Debian 的服务器。</p><p><img src="https://anarckk.github.io/mypico/img/bt_trackers.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/bt_trackers.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="bt_trackers"></p><blockquote><p>Of course, these central servers are liable to get raided by the feds if they facilitate peers exchanging illegal content. You may remember reading about trackers like TorrentSpy, Popcorn Time, and KickassTorrents getting seized and shut down. <strong>New methods cut out the middleman by making [even peer discovery] [a distributed process.]</strong> We won’t be implementing them, but if you’re interested, some terms you can research are DHT, PEX, and magnet links.</p></blockquote><p>当然，如果这些中央服务器促进用户交换非法内容，它们就有可能被联邦政府突袭。你可能记得读过像 TorrentSpy、Popcorn Time 和 KickassTorrents 这样的跟踪器被查封和关闭的新闻。新方法甚至将发现 peer 也变成了一个分布式过程，从而省去了中间环节。我们不会实现它们，但如果您感兴趣，可以研究一下DHT、PEX和磁力链接。</p><h2 id="Parsing-a-torrent-file"><a href="#Parsing-a-torrent-file" class="headerlink" title="Parsing a .torrent file"></a>Parsing a .torrent file</h2><blockquote><p>A .torrent file describes the contents of a torrentable file and information for connecting to a tracker. It’s all we need in order to kickstart the process of downloading a torrent. Debian’s .torrent file looks like this:</p></blockquote><p>.torrent 文件描述了可下载文件的内容以及连接到跟踪器的信息。我们只需要它就可以启动下载 torrent 的过程。Debian 的 .torrent 文件看起来像这样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:&quot;Debian CD from cdimage.debian.org&quot;13:creation datei1573903810e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.isoe4:infod6:lengthi351272960e4:name31:debian-10.2.0-amd64-netinst.iso12:piece lengthi262144e6:pieces26800:�����PS�^�� (binary blob of the hashes of each piece)ee</span><br></pre></td></tr></table></figure><blockquote><p>That mess is encoded in a format called Bencode (pronounced bee-encode), and we’ll need to decode it.</p></blockquote><p>这一堆被编码成叫做 Beancode (pronounced bee-encode) 的格式，我们需要解码它。</p><blockquote><p>Bencode can encode roughly the same types of structures as JSON—strings, integers, lists, and dictionaries. Bencoded data is not as human-readable&#x2F;writable as JSON, but it can efficiently handle binary data and it’s really simple to parse from a stream. Strings come with a length prefix, and look like 4:spam. Integers go between start and end markers, so 7 would encode to i7e. Lists and dictionaries work in a similar way: l4:spami7ee represents [‘spam’, 7], while d4:spami7ee means {spam: 7}.</p></blockquote><p>Bencode 可编码的结构类型与 JSON 大致相同–字符串、整数、列表和字典。Bencoded 数据不像 JSON 那样可由人类读取&#x2F;写入，但它能有效处理二进制数据，而且从数据流中进行解析也非常简单。字符串带有长度前缀，看起来像 4:spam。整数介于起始和结束标记之间，因此 7 将编码为 i7e。列表和字典的编码方法长的很像：<code>l4:spami7ee</code>代表[‘spam’, 7], <code>d4:spami7ee</code> 意思是 {spam: 7}</p><blockquote><p>In a prettier format, our .torrent file looks like this:</p></blockquote><p>以更漂亮的格式，我们的 .torrent 文件看起来像这样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">d</span><br><span class="line">  8:announce</span><br><span class="line">    41:http://bttracker.debian.org:6969/announce</span><br><span class="line">  7:comment</span><br><span class="line">    35:&quot;Debian CD from cdimage.debian.org&quot;</span><br><span class="line">  13:creation date</span><br><span class="line">    i1573903810e</span><br><span class="line">  4:info</span><br><span class="line">    d</span><br><span class="line">      6:length</span><br><span class="line">        i351272960e</span><br><span class="line">      4:name</span><br><span class="line">        31:debian-10.2.0-amd64-netinst.iso</span><br><span class="line">      12:piece length</span><br><span class="line">        i262144e</span><br><span class="line">      6:pieces</span><br><span class="line">        26800:�����PS�^�� (binary blob of the hashes of each piece)</span><br><span class="line">    e</span><br><span class="line">e</span><br></pre></td></tr></table></figure><blockquote><p>In this file, we can spot the URL of the tracker, the creation date (as a Unix timestamp), the name and size of the file, and a big binary blob containing the SHA-1 hashes of each piece, which are equally-sized parts of the file we want to download. The exact size of a piece varies between torrents, but they are usually somewhere between 256KB and 1MB. This means that a large file might be made up of thousands of pieces. We’ll download these pieces from our peers, check them against the hashes from our torrent file, assemble them together, and boom, we’ve got a file!</p></blockquote><p>在这个文件中，我们可以找到跟踪器的URL、创建日期（以Unix时间戳形式）、文件的名称和大小，以及一个包含SHA-1哈希值的大二进制数据块。这些哈希值对应于我们要下载的文件的等大小部分。每个部分的确切大小因种子文件而异，但通常在256KB到1MB之间。这意味着一个大文件可能由成千上万个部分组成。我们将从其他的用户那里下载这些部分，然后与种子文件中的哈希值进行校验，将它们组装在一起，最终得到完整的文件！</p><p><img src="https://anarckk.github.io/mypico/img/bt_pieces.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/bt_pieces.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="bt_pieces"></p><blockquote><p>This mechanism allows us to verify the integrity of each piece as we go. It makes BitTorrent resistant to accidental corruption or intentional torrent poisoning. Unless an attacker is capable of breaking SHA-1 with a <strong>preimage</strong> attack, we will get exactly the content we asked for.</p></blockquote><p>通过这一机制，我们可以验证每个片段的完整性。这使得BitTorrent对于意外损坏或故意的种子污染具有一定的抵抗能力。除非攻击者能够通过<strong>预像</strong>攻击破解SHA-1，否则我们将会得到我们所请求的确切内容。</p><blockquote><p>It would be really fun to write a bencode parser, but parsing isn’t our focus today. But I found Fredrik Lundh’s 50 line parser to be especially illuminating. For this project, I used github.com&#x2F;jackpal&#x2F;bencode-go:</p></blockquote><p>编写一个bencode解析器确实会很有趣，但是解析并不是我们今天的重点。不过我发现Fredrik Lundh的50行解析器特别有启发性。在这个项目中，我使用了github.com&#x2F;jackpal&#x2F;bencode-go。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/jackpal/bencode-go&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> bencodeInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">    Pieces      <span class="type">string</span> <span class="string">`bencode:&quot;pieces&quot;`</span></span><br><span class="line">    PieceLength <span class="type">int</span>    <span class="string">`bencode:&quot;piece length&quot;`</span></span><br><span class="line">    Length      <span class="type">int</span>    <span class="string">`bencode:&quot;length&quot;`</span></span><br><span class="line">    Name        <span class="type">string</span> <span class="string">`bencode:&quot;name&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> bencodeTorrent <span class="keyword">struct</span> &#123;</span><br><span class="line">    Announce <span class="type">string</span>      <span class="string">`bencode:&quot;announce&quot;`</span></span><br><span class="line">    Info     bencodeInfo <span class="string">`bencode:&quot;info&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open parses a torrent file</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(r io.Reader)</span></span> (*bencodeTorrent, <span class="type">error</span>) &#123;</span><br><span class="line">    bto := bencodeTorrent&#123;&#125;</span><br><span class="line">    err := bencode.Unmarshal(r, &amp;bto)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;bto, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Because I like to keep my structures relatively flat, and I like to keep my application structs separate from my serialization structs, I exported a different, flatter struct named TorrentFile and wrote a few helper functions to convert between the two.</p></blockquote><p>因为我喜欢保持我的结构相对扁平化，并且喜欢将我的应用程序结构与序列化结构分开，所以我导出了一个不同的、更加扁平的结构体，命名为TorrentFile，并编写了一些辅助函数来在这两者之间进行转换。</p><blockquote><p>Notably, I split pieces (previously a string) into a slice of hashes (each [20]byte) so that I can easily access individual hashes later. I also computed the SHA-1 hash of the entire bencoded info dict (the one which contained the name, size, and piece hashes). We know this as the infohash and it uniquely identifies files when we talk to trackers and peers. More on this later.</p></blockquote><p>值得注意的是，我将之前作为字符串的pieces拆分成了一个哈希切片（每个哈希为[20]byte），这样我可以轻松地在以后访问单个哈希。我还计算了整个bencoded info字典（包含名称、大小和分块哈希）的SHA-1哈希值。我们称之为infohash，它在我们与跟踪器和其他用户通信时唯一地标识文件。关于这个后面会详细介绍。</p><p><img src="https://anarckk.github.io/mypico/img/torrent-info-hash.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/torrent-info-hash.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="torrent-info-hash"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TorrentFile <span class="keyword">struct</span> &#123;</span><br><span class="line">    Announce    <span class="type">string</span></span><br><span class="line">    InfoHash    [<span class="number">20</span>]<span class="type">byte</span></span><br><span class="line">    PieceHashes [][<span class="number">20</span>]<span class="type">byte</span></span><br><span class="line">    PieceLength <span class="type">int</span></span><br><span class="line">    Length      <span class="type">int</span></span><br><span class="line">    Name        <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bto bencodeTorrent)</span></span> toTorrentFile() (TorrentFile, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// …</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Retrieving-peers-from-the-tracker"><a href="#Retrieving-peers-from-the-tracker" class="headerlink" title="Retrieving peers from the tracker"></a>Retrieving peers from the tracker</h2><blockquote><p>Now that we have information about the file and its tracker, let’s talk to the tracker to announce our presence as a peer and to retrieve a list of other peers. We just need to make a GET request to the announce URL supplied in the .torrent file, with a few query parameters:</p></blockquote><p>既然我们已经获取了关于文件和跟踪器的信息，让我们与跟踪器通信，向其宣告我们作为一个对等节点的存在，并获取其他对等节点的列表。我们只需要向.torrent文件提供的announce URL发起一个GET请求，并附带一些查询参数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TorrentFile)</span></span> buildTrackerURL(peerID [<span class="number">20</span>]<span class="type">byte</span>, port <span class="type">uint16</span>) (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    base, err := url.Parse(t.Announce)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    params := url.Values&#123;</span><br><span class="line">        <span class="string">&quot;info_hash&quot;</span>:  []<span class="type">string</span>&#123;<span class="type">string</span>(t.InfoHash[:])&#125;,</span><br><span class="line">        <span class="string">&quot;peer_id&quot;</span>:    []<span class="type">string</span>&#123;<span class="type">string</span>(peerID[:])&#125;,</span><br><span class="line">        <span class="string">&quot;port&quot;</span>:       []<span class="type">string</span>&#123;strconv.Itoa(<span class="type">int</span>(Port))&#125;,</span><br><span class="line">        <span class="string">&quot;uploaded&quot;</span>:   []<span class="type">string</span>&#123;<span class="string">&quot;0&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;downloaded&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;0&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;compact&quot;</span>:    []<span class="type">string</span>&#123;<span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;left&quot;</span>:       []<span class="type">string</span>&#123;strconv.Itoa(t.Length)&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    base.RawQuery = params.Encode()</span><br><span class="line">    <span class="keyword">return</span> base.String(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The important ones:(其中一些重要的参数有：)</p><blockquote><ul><li>info_hash: Identifies the file we’re trying to download. It’s the infohash we calculated earlier from the bencoded info dict. The tracker will use this to figure out which peers to show us.</li><li>peer_id: A 20 byte name to identify ourselves to trackers and peers. We’ll just generate 20 random bytes for this. Real BitTorrent clients have IDs like -TR2940-k8hj0wgej6ch which identify the client software and version—in this case, TR2940 stands for Transmission client 2.94.</li></ul></blockquote><ul><li>info_hash: 标识我们要下载的文件，即我们之前从bencoded info字典计算得到的infohash。跟踪器将使用此信息确定要显示给我们的对等节点。</li><li>peer_id: 用于向跟踪器和其他对等节点标识我们自己的20字节名称。我们将为此生成20个随机字节。真实的BitTorrent客户端具有像-TR2940-k8hj0wgej6ch这样的ID，用于标识客户端软件和版本——在本例中，TR2940代表Transmission客户端2.94版本。</li></ul><p><img src="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__info-hash-peer-id.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__info-hash-peer-id.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="blog.jse.li__torrent__info-hash-peer-id"></p><h2 id="Parsing-the-tracker-response"><a href="#Parsing-the-tracker-response" class="headerlink" title="Parsing the tracker response"></a>Parsing the tracker response</h2><p>We get back a bencoded response:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">d</span><br><span class="line">  8:interval</span><br><span class="line">    i900e</span><br><span class="line">  5:peers</span><br><span class="line">    252:(another long binary blob)</span><br><span class="line">e</span><br></pre></td></tr></table></figure><blockquote><p><code>Interval</code> tells us how often we’re supposed to connect to the tracker again to refresh our list of peers. A value of 900 means we should reconnect every 15 minutes (900 seconds).</p></blockquote><p>Interval告诉我们应该多久连接一次跟踪器以刷新我们的对等节点列表。值900告诉我们应该每隔15分钟(900秒)刷新一次。</p><blockquote><p><code>Peers</code> is another long binary blob containing the IP addresses of each peer. It’s made out of groups of six bytes. The first four bytes in each group represent the peer’s IP address—each byte represents a number in the IP. The last two bytes represent the port, as a big-endian uint16. Big-endian, or network order, means that we can interpret a group of bytes as an integer by just squishing them together left to right. For example, the bytes 0x1A, 0xE1 make 0x1AE1, or 6881 in decimal.*</p></blockquote><p>Peers是另一个包含每个对等节点的IP地址的长二进制数据块。它由六字节一组构成。每个组中的前四个字节代表对等节点的IP地址，其中每个字节表示IP地址中的一个数字。最后两个字节以大端字节序表示端口，作为一个无符号的16位整数（uint16）。大端序（或网络字节序）意味着我们可以通过将一组字节从左到右拼接在一起来将其解释为一个整数。例如，字节0x1A和0xE1可以组成0x1AE1，即十进制的6881。</p><p><img src="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__address.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__address.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="blog.jse.li__torrent__address"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Peer encodes connection information for a peer</span></span><br><span class="line"><span class="keyword">type</span> Peer <span class="keyword">struct</span> &#123;</span><br><span class="line">    IP   net.IP</span><br><span class="line">    Port <span class="type">uint16</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unmarshal parses peer IP addresses and ports from a buffer</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Unmarshal</span><span class="params">(peersBin []<span class="type">byte</span>)</span></span> ([]Peer, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> peerSize = <span class="number">6</span> <span class="comment">// 4 for IP, 2 for port</span></span><br><span class="line">    numPeers := <span class="built_in">len</span>(peersBin) / peerSize</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(peersBin)%peerSize != <span class="number">0</span> &#123;</span><br><span class="line">        err := fmt.Errorf(<span class="string">&quot;Received malformed peers&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    peers := <span class="built_in">make</span>([]Peer, numPeers)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; numPeers; i++ &#123;</span><br><span class="line">        offset := i * peerSize</span><br><span class="line">        peers[i].IP = net.IP(peersBin[offset : offset+<span class="number">4</span>])</span><br><span class="line">        peers[i].Port = binary.BigEndian.Uint16(peersBin[offset+<span class="number">4</span> : offset+<span class="number">6</span>])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> peers, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Downloading-from-peers"><a href="#Downloading-from-peers" class="headerlink" title="Downloading from peers"></a>Downloading from peers</h2><blockquote><p>Now that we have a list of peers, it’s time to connect with them and start downloading pieces! We can break down the process into a few steps. For each peer, we want to:</p></blockquote><p>既然我们有了对等节点的列表，现在是时候与它们建立连接并开始下载部分文件了！我们可以将这个过程分解为几个步骤。对于每个对等节点，我们希望：</p><ol><li>Start a TCP connection with the peer. This is like starting a phone call.</li><li>Complete a two-way BitTorrent handshake. “Hello?” “Hello.”</li><li>Exchange messages to download pieces. “I’d like piece #231 please.”</li></ol><h2 id="Start-a-TCP-connection"><a href="#Start-a-TCP-connection" class="headerlink" title="Start a TCP connection"></a>Start a TCP connection</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conn, err := net.DialTimeout(<span class="string">&quot;tcp&quot;</span>, peer.String(), <span class="number">3</span>*time.Second)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>I set a timeout so that I don’t waste too much time on peers that aren’t going to let me connect. For the most part, it’s a pretty standard TCP connection.</p></blockquote><p>我设置了一个超时时间，这样我就不会浪费太多时间在不让我连接的对等节点上。大部分情况下，这是一个相当标准的TCP连接。</p><h2 id="Complete-the-handshake"><a href="#Complete-the-handshake" class="headerlink" title="Complete the handshake"></a>Complete the handshake</h2><blockquote><p>We’ve just set up a connection with a peer, but we want do a handshake to validate our assumptions that the peer:</p></blockquote><p>我们刚刚与一个对等节点建立了连接，但我们希望进行握手来验证以下假设，即对等节点：</p><ol><li>can communicate using the BitTorrent protocol</li><li>is able to understand and respond to our messages</li><li>has the file that we want, or at least knows what we’re talking about</li></ol><p><img src="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__handshake.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__handshake.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="blog.jse.li__torrent__handshake"></p><blockquote><p>My father told me that the secret to a good handshake is a firm grip and eye contact. The secret to a good BitTorrent handshake is that it’s made up of five parts:</p></blockquote><p>父亲告诉我，一个好的握手的秘诀是握手要坚定，同时要有眼神接触。而一个良好的BitTorrent握手的秘诀在于它由五个部分组成：</p><ol><li><p>The length of the protocol identifier, which is always 19 (0x13 in hex)</p></li><li><p>The protocol identifier, called the pstr which is always BitTorrent protocol</p></li><li><p>Eight reserved bytes, all set to 0. We’d flip some of them to 1 to indicate that we support certain extensions. But we don’t, so we’ll keep them at 0.</p></li><li><p>The infohash that we calculated earlier to identify which file we want</p></li><li><p>The Peer ID that we made up to identify ourselves</p></li><li><p>协议标识符的长度，始终为19（十六进制为0x13）。</p></li><li><p>协议标识符，称为pstr，始终为”BitTorrent protocol”。</p></li><li><p>保留的8个字节，全部设置为0。如果我们支持某些扩展，我们会将其中一些字节设置为1来指示。但因为我们不支持任何扩展，所以我们将它们保持为0。</p></li><li><p>我们之前计算的infohash，用于标识我们想要下载的文件。</p></li><li><p>我们编造的对等节点标识（Peer ID），用于标识我们自己。</p></li></ol><blockquote><p>Put together, a handshake string might look like this:</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x13BitTorrent protocol\x00\x00\x00\x00\x00\x00\x00\x00\x86\xd4\xc8\x00\x24\xa4\x69\xbe\x4c\x50\xbc\x5a\x10\x2c\xf7\x17\x80\x31\x00\x74-TR2940-k8hj0wgej6ch</span><br></pre></td></tr></table></figure><blockquote><p>After we send a handshake to our peer, we should receive a handshake back in the same format. The infohash we get back should match the one we sent so that we know that we’re talking about the same file. If everything goes as planned, we’re good to go. If not, we can <strong>sever</strong> the connection because there’s something wrong. “Hello?” “这是谁？ 你想要什么？” “Okay, wow, wrong number.”</p></blockquote><p>在我们向对等节点发送握手后，我们应该以相同的格式收到握手回复。回复中的infohash应该与我们发送的一致，这样我们就知道我们正在讨论同一个文件。如果一切按计划进行，我们就可以开始了。如果有问题，我们可以终止连接，因为出现了错误。“你好？” “这是谁？你想要什么？” “哇，好吧，打错电话了。”</p><blockquote><p>In our code, let’s make a struct to represent a handshake, and write a few methods for serializing and reading them:</p></blockquote><p>在我们的代码中，让我们创建一个结构体来表示握手，并编写一些方法来进行序列化和读取：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Handshake is a special message that a peer uses to identify itself</span></span><br><span class="line"><span class="keyword">type</span> Handshake <span class="keyword">struct</span> &#123;</span><br><span class="line">    Pstr     <span class="type">string</span></span><br><span class="line">    InfoHash [<span class="number">20</span>]<span class="type">byte</span></span><br><span class="line">    PeerID   [<span class="number">20</span>]<span class="type">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serialize serializes the handshake to a buffer</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handshake)</span></span> Serialize() []<span class="type">byte</span> &#123;</span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(h.Pstr)+<span class="number">49</span>)</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="type">byte</span>(<span class="built_in">len</span>(h.Pstr))</span><br><span class="line">    curr := <span class="number">1</span></span><br><span class="line">    curr += <span class="built_in">copy</span>(buf[curr:], h.Pstr)</span><br><span class="line">    curr += <span class="built_in">copy</span>(buf[curr:], <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">8</span>)) <span class="comment">// 8 reserved bytes</span></span><br><span class="line">    curr += <span class="built_in">copy</span>(buf[curr:], h.InfoHash[:])</span><br><span class="line">    curr += <span class="built_in">copy</span>(buf[curr:], h.PeerID[:])</span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read parses a handshake from a stream</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Read</span><span class="params">(r io.Reader)</span></span> (*Handshake, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// Do Serialize(), but backwards</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Send-and-receive-messages"><a href="#Send-and-receive-messages" class="headerlink" title="Send and receive messages"></a>Send and receive messages</h2><blockquote><p>Once we’ve completed the initial handshake, we can send and receive messages. Well, not quite—if the other peer isn’t ready to accept messages, we can’t send any until they tell us they’re ready. In this state, we’re considered choked by the other peer. They’ll send us an unchoke message to let us know that we can begin asking them for data. By default, we assume that we’re choked until proven otherwise.</p></blockquote><p>一旦完成初始握手，我们就可以发送和接收消息。不过，如果对方对接收消息还没有准备好，我们就无法发送任何消息，直到他们告诉我们他们已准备好。在这种状态下，对方认为我们被阻塞了。他们会发送一个取消阻塞的消息（unchoke message），以让我们知道我们可以开始向他们请求数据。默认情况下，我们假设自己被阻塞，除非有证据表明相反。</p><blockquote><p>Once we’ve been unchoked, we can then begin sending requests for pieces, and they can send us messages back containing pieces.</p></blockquote><p>一旦我们被解除阻塞，我们就可以开始发送对部分文件的请求，而对方则可以回复我们包含部分文件的消息。</p><p><img src="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__choke.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__choke.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="blog.jse.li__torrent__choke"></p><h2 id="Interpreting-messages"><a href="#Interpreting-messages" class="headerlink" title="Interpreting messages"></a>Interpreting messages</h2><blockquote><p>A message has a length, an ID and a payload. <strong>On the wire</strong>, it looks like:</p></blockquote><p>每个消息都包含长度、ID和负载。在传输过程中，它的格式如下所示：</p><p><img src="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__message.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__message.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="blog.jse.li__torrent__message"></p><blockquote><p>A message starts with a length indicator which tells us how many bytes long the message will be. It’s a 32-bit integer, meaning it’s made out of four bytes smooshed together in big-endian order. The next byte, the ID, tells us which type of message we’re receiving—for example, a 2 byte means “interested.” Finally, the optional payload fills out the remaining length of the message.</p></blockquote><p>一条消息以长度指示器开始，告诉我们消息将有多少字节长。这是一个32位整数，意味着它由四个按大端序排列在一起的字节组成。接下来的一个字节，即ID，告诉我们我们正在接收哪种类型的消息，例如，2个字节表示“感兴趣”。最后，可选的有效载荷填充了消息的剩余长度。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> messageID <span class="type">uint8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    MsgChoke         messageID = <span class="number">0</span></span><br><span class="line">    MsgUnchoke       messageID = <span class="number">1</span></span><br><span class="line">    MsgInterested    messageID = <span class="number">2</span></span><br><span class="line">    MsgNotInterested messageID = <span class="number">3</span></span><br><span class="line">    MsgHave          messageID = <span class="number">4</span></span><br><span class="line">    MsgBitfield      messageID = <span class="number">5</span></span><br><span class="line">    MsgRequest       messageID = <span class="number">6</span></span><br><span class="line">    MsgPiece         messageID = <span class="number">7</span></span><br><span class="line">    MsgCancel        messageID = <span class="number">8</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Message stores ID and payload of a message</span></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      messageID</span><br><span class="line">    Payload []<span class="type">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serialize serializes a message into a buffer of the form</span></span><br><span class="line"><span class="comment">// &lt;length prefix&gt;&lt;message ID&gt;&lt;payload&gt;</span></span><br><span class="line"><span class="comment">// Interprets `nil` as a keep-alive message</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Message)</span></span> Serialize() []<span class="type">byte</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> m == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    length := <span class="type">uint32</span>(<span class="built_in">len</span>(m.Payload) + <span class="number">1</span>) <span class="comment">// +1 for id</span></span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>+length)</span><br><span class="line">    binary.BigEndian.PutUint32(buf[<span class="number">0</span>:<span class="number">4</span>], length)</span><br><span class="line">    buf[<span class="number">4</span>] = <span class="type">byte</span>(m.ID)</span><br><span class="line">    <span class="built_in">copy</span>(buf[<span class="number">5</span>:], m.Payload)</span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>To read a message from a stream, we just follow the format of a message. We read four bytes and interpret them as a uint32 to get the length of the message. Then, we read that number of bytes to get the ID (the first byte) and the payload (the remaining bytes).</p></blockquote><p>要从流中读取一条消息，我们只需按照消息的格式进行操作。我们先读取四个字节，并将它们解释为uint32类型，以获取消息的长度。然后，我们读取相应数量的字节来获取ID（第一个字节）和有效载荷（剩余字节）。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read parses a message from a stream. Returns `nil` on keep-alive message</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Read</span><span class="params">(r io.Reader)</span></span> (*Message, <span class="type">error</span>) &#123;</span><br><span class="line">    lengthBuf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)</span><br><span class="line">    _, err := io.ReadFull(r, lengthBuf)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    length := binary.BigEndian.Uint32(lengthBuf)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// keep-alive message</span></span><br><span class="line">    <span class="keyword">if</span> length == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    messageBuf := <span class="built_in">make</span>([]<span class="type">byte</span>, length)</span><br><span class="line">    _, err = io.ReadFull(r, messageBuf)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m := Message&#123;</span><br><span class="line">        ID:      messageID(messageBuf[<span class="number">0</span>]),</span><br><span class="line">        Payload: messageBuf[<span class="number">1</span>:],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;m, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Bitfields"><a href="#Bitfields" class="headerlink" title="Bitfields"></a>Bitfields</h2><blockquote><p>One of the most interesting types of message is the <strong>bitfield</strong>, which is a data structure that peers use to efficiently encode which pieces they are able to send us. A bitfield looks like a byte array, and to check which pieces they have, we just need to look at the positions of the bits set to 1. You can think of it like the digital equivalent of a coffee shop loyalty card. We start with a blank card of all 0, and flip bits to 1 to mark their positions as “stamped.”</p></blockquote><p>最有趣的消息类型之一是位域（bitfield），它是一种数据结构，用于对等方有效地编码他们能够向我们发送的片段。位域看起来像一个字节数组，要检查他们拥有哪些片段，我们只需查看被设为1的位的位置。你可以将其视为咖啡店会员卡的数字等效物。我们从一张全为0的空白卡开始，通过将位设为1来标记它们的位置为“已盖章”。</p><p><img src="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__bitfield.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__bitfield.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="blog.jse.li__torrent__bitfield"></p><blockquote><p>By working with bits instead of bytes, this data structure is super compact. We can stuff information about eight pieces in the space of a single byte—the size of a bool. The tradeoff is that accessing values becomes a little more tricky. The smallest unit of memory that computers can address are bytes, so to get to our bits, we have to do some bitwise manipulation:</p></blockquote><p>通过使用位而不是字节，这种数据结构非常紧凑。我们可以在一个字节的空间内储存关于八个片段的信息，而一个字节的大小就是一个布尔值。这样做的一个权衡是访问值变得有点复杂。计算机可以寻址的最小内存单位是字节，所以要访问我们的位，我们需要进行一些位操作：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Bitfield represents the pieces that a peer has</span></span><br><span class="line"><span class="keyword">type</span> Bitfield []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HasPiece tells if a bitfield has a particular index set</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bf Bitfield)</span></span> HasPiece(index <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    byteIndex := index / <span class="number">8</span></span><br><span class="line">    offset := index % <span class="number">8</span></span><br><span class="line">    <span class="keyword">return</span> bf[byteIndex]&gt;&gt;(<span class="number">7</span>-offset)&amp;<span class="number">1</span> != <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetPiece sets a bit in the bitfield</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bf Bitfield)</span></span> SetPiece(index <span class="type">int</span>) &#123;</span><br><span class="line">    byteIndex := index / <span class="number">8</span></span><br><span class="line">    offset := index % <span class="number">8</span></span><br><span class="line">    bf[byteIndex] |= <span class="number">1</span> &lt;&lt; (<span class="number">7</span> - offset)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Putting-it-all-together"><a href="#Putting-it-all-together" class="headerlink" title="Putting it all together"></a>Putting it all together</h2><blockquote><p>We now have all the tools we need to download a torrent: we have a list of peers obtained from the tracker, and we can communicate with them by dialing a TCP connection, initiating a handshake, and sending and receiving messages. Our last big problems are handling the concurrency involved in talking to multiple peers at once, and managing the state of our peers as we interact with them. These are both classically Hard problems.</p></blockquote><p>我们现在拥有下载种子所需的所有工具：我们从追踪器获取了对等方列表，并且可以通过拨号TCP连接与它们通信，发起握手，并发送和接收消息。我们最后面临的两个大问题是同时与多个对等方通信时处理并发，以及在与他们互动时管理对等方的状态。这两个问题都属于经典的难题。</p><h3 id="Managing-concurrency-channels-as-queues"><a href="#Managing-concurrency-channels-as-queues" class="headerlink" title="Managing concurrency: channels as queues"></a>Managing concurrency: channels as queues</h3><blockquote><p>In Go, we <a href="https://go.dev/blog/codelab-share">share memory by communicating</a>, and we can think of a Go channel as a cheap thread-safe queue.</p></blockquote><p>在Go语言中，我们通过通信来共享内存，并且可以将Go通道视为一种廉价的线程安全队列。</p><blockquote><p>We’ll set up two channels to synchronize our concurrent workers: one for dishing out work (pieces to download) between peers, and another for collecting downloaded pieces. As downloaded pieces come in through the results channel, we can copy them into a buffer to start assembling our complete file.</p></blockquote><p>我们将设置两个通道来同步我们的并发工作器：一个用于在对等方之间分配工作（要下载的片段），另一个用于收集已下载的片段。当下载的片段通过结果通道进入时，我们可以将它们复制到缓冲区中，以开始组装完整的文件。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init queues for workers to retrieve work and send results</span></span><br><span class="line">workQueue := <span class="built_in">make</span>(<span class="keyword">chan</span> *pieceWork, <span class="built_in">len</span>(t.PieceHashes))</span><br><span class="line">results := <span class="built_in">make</span>(<span class="keyword">chan</span> *pieceResult)</span><br><span class="line"><span class="keyword">for</span> index, hash := <span class="keyword">range</span> t.PieceHashes &#123;</span><br><span class="line">    length := t.calculatePieceSize(index)</span><br><span class="line">    workQueue &lt;- &amp;pieceWork&#123;index, hash, length&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start workers</span></span><br><span class="line"><span class="keyword">for</span> _, peer := <span class="keyword">range</span> t.Peers &#123;</span><br><span class="line">    <span class="keyword">go</span> t.startDownloadWorker(peer, workQueue, results)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect results into a buffer until full</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, t.Length)</span><br><span class="line">donePieces := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> donePieces &lt; <span class="built_in">len</span>(t.PieceHashes) &#123;</span><br><span class="line">    res := &lt;-results</span><br><span class="line">    begin, end := t.calculateBoundsForPiece(res.index)</span><br><span class="line">    <span class="built_in">copy</span>(buf[begin:end], res.buf)</span><br><span class="line">    donePieces++</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">close</span>(workQueue)</span><br></pre></td></tr></table></figure><blockquote><p>We’ll spawn a worker goroutine for each peer we’ve received from the tracker. It’ll connect and handshake with the peer, and then start retrieving work from the workQueue, attempting to download it, and sending downloaded pieces back through the results channel.</p></blockquote><p>对于从追踪器接收到的每个对等方，我们将生成一个工作协程（goroutine）。它将与对等方建立连接并进行握手，然后开始从工作队列中获取任务，尝试下载它，并通过结果通道发送已下载的片段。</p><p><img src="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__download.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__download.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="blog.jse.li__torrent__download"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Torrent)</span></span> startDownloadWorker(peer peers.Peer, workQueue <span class="keyword">chan</span> *pieceWork, results <span class="keyword">chan</span> *pieceResult) &#123;</span><br><span class="line">    c, err := client.New(peer, t.PeerID, t.InfoHash)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Could not handshake with %s. Disconnecting\n&quot;</span>, peer.IP)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> c.Conn.Close()</span><br><span class="line">    log.Printf(<span class="string">&quot;Completed handshake with %s\n&quot;</span>, peer.IP)</span><br><span class="line"></span><br><span class="line">    c.SendUnchoke()</span><br><span class="line">    c.SendInterested()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> pw := <span class="keyword">range</span> workQueue &#123;</span><br><span class="line">        <span class="keyword">if</span> !c.Bitfield.HasPiece(pw.index) &#123;</span><br><span class="line">            workQueue &lt;- pw <span class="comment">// Put piece back on the queue</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Download the piece</span></span><br><span class="line">        buf, err := attemptDownloadPiece(c, pw)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Println(<span class="string">&quot;Exiting&quot;</span>, err)</span><br><span class="line">            workQueue &lt;- pw <span class="comment">// Put piece back on the queue</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        err = checkIntegrity(pw, buf)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;Piece #%d failed integrity check\n&quot;</span>, pw.index)</span><br><span class="line">            workQueue &lt;- pw <span class="comment">// Put piece back on the queue</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        c.SendHave(pw.index)</span><br><span class="line">        results &lt;- &amp;pieceResult&#123;pw.index, buf&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Managing-state"><a href="#Managing-state" class="headerlink" title="Managing state"></a>Managing state</h3><blockquote><p>We’ll keep track of each peer in a struct, and modify that struct as we read messages. It’ll include data like how much we’ve downloaded from the peer, how much we’ve requested from them, and whether we’re choked. If we wanted to scale this further, we could formalize this as a finite state machine. But a struct and a switch are good enough for now.</p></blockquote><p>我们将在一个结构体中跟踪每个对等方，并在读取消息时修改该结构体。结构体将包括我们从对等方下载了多少数据，我们向他们请求了多少数据，以及我们是否被阻塞的信息。如果我们希望进一步扩展，我们可以将其形式化为有限状态机。但是目前来说，一个结构体和一个 switch 语句已经足够了。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> pieceProgress <span class="keyword">struct</span> &#123;</span><br><span class="line">    index      <span class="type">int</span></span><br><span class="line">    client     *client.Client</span><br><span class="line">    buf        []<span class="type">byte</span></span><br><span class="line">    downloaded <span class="type">int</span></span><br><span class="line">    requested  <span class="type">int</span></span><br><span class="line">    backlog    <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(state *pieceProgress)</span></span> readMessage() <span class="type">error</span> &#123;</span><br><span class="line">    msg, err := state.client.Read() <span class="comment">// this call blocks</span></span><br><span class="line">    <span class="keyword">switch</span> msg.ID &#123;</span><br><span class="line">    <span class="keyword">case</span> message.MsgUnchoke:</span><br><span class="line">        state.client.Choked = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">case</span> message.MsgChoke:</span><br><span class="line">        state.client.Choked = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">case</span> message.MsgHave:</span><br><span class="line">        index, err := message.ParseHave(msg)</span><br><span class="line">        state.client.Bitfield.SetPiece(index)</span><br><span class="line">    <span class="keyword">case</span> message.MsgPiece:</span><br><span class="line">        n, err := message.ParsePiece(state.index, state.buf, msg)</span><br><span class="line">        state.downloaded += n</span><br><span class="line">        state.backlog--</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Time-to-make-requests"><a href="#Time-to-make-requests" class="headerlink" title="Time to make requests!"></a>Time to make requests!</h3><blockquote><p>Files, pieces, and piece hashes aren’t the full story—we can go further by breaking down pieces into blocks. A block is a part of a piece, and we can fully define a block by the index of the piece it’s part of, its byte offset within the piece, and its length. When we make requests for data from peers, we are actually requesting blocks. A block is usually 16KB large, meaning that a single 256 KB piece might actually require 16 requests.</p></blockquote><p>文件、片段和片段哈希并不是全部的故事——我们可以通过将片段进一步拆分为块来进行更深入的处理。一个块是片段的一部分，我们可以通过它所属的片段索引、在片段内的字节偏移和长度来完全定义一个块。当我们向对等方请求数据时，实际上是在请求块。一个块通常为16KB大小，这意味着单个256KB的片段可能需要16次请求才能完全获取。</p><blockquote><p>A peer is supposed to sever the connection if they receive a request for a block larger than 16KB. However, based on my experience, they’re often perfectly happy to satisfy requests up to 128KB. I only got moderate gains in overall speed with larger block sizes, so it’s probably better to stick with the spec.</p></blockquote><p>如果对等方接收到一个大于16KB的块请求，它应该断开连接。然而，根据我的经验，它们通常很乐意满足多达128KB的请求。使用更大的块大小只能带来适度的整体速度提升，所以遵循规范可能更好一些。</p><h3 id="Pipelining"><a href="#Pipelining" class="headerlink" title="Pipelining"></a>Pipelining</h3><blockquote><p>Network round-trips are expensive, and requesting each block one by one will absolutely tank the performance of our download. Therefore, it’s important to pipeline our requests such that we keep up a constant pressure of some number of unfulfilled requests. This can increase the throughput of our connection by an order of magnitude.</p></blockquote><p>网络往返时间很昂贵，逐个请求每个块将严重降低下载性能。因此，重要的是通过流水线方式发出请求，以保持一定数量的未满足请求的持续压力。这可以将连接的吞吐量提高一个数量级</p><p><img src="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__pipelining.png" class="lazyload" data-srcset="https://anarckk.github.io/mypico/img/blog.jse.li__torrent__pipelining.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="blog.jse.li__torrent__pipelining"></p><blockquote><p>Classically, BitTorrent clients kept a queue of five pipelined requests, and that’s the value I’ll be using. I found that increasing it can up to double the speed of a download. Newer clients use an adaptive queue size to better accommodate modern network speeds and conditions. This is definitely a parameter worth tweaking, and it’s pretty low hanging fruit for future performance optimization.</p></blockquote><p>经典的BitTorrent客户端通常保持一个包含5个流水线请求的队列，这是我将要使用的值。我发现增加这个值可以将下载速度提高一倍。较新的客户端使用自适应队列大小来更好地适应现代网络速度和条件。这绝对是一个值得调整的参数，对于未来的性能优化来说是一个较为低 hanging fruit。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MaxBlockSize is the largest number of bytes a request can ask for</span></span><br><span class="line"><span class="keyword">const</span> MaxBlockSize = <span class="number">16384</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MaxBacklog is the number of unfulfilled requests a client can have in its pipeline</span></span><br><span class="line"><span class="keyword">const</span> MaxBacklog = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">attemptDownloadPiece</span><span class="params">(c *client.Client, pw *pieceWork)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    state := pieceProgress&#123;</span><br><span class="line">        index:  pw.index,</span><br><span class="line">        client: c,</span><br><span class="line">        buf:    <span class="built_in">make</span>([]<span class="type">byte</span>, pw.length),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setting a deadline helps get unresponsive peers unstuck.</span></span><br><span class="line">    <span class="comment">// 30 seconds is more than enough time to download a 262 KB piece</span></span><br><span class="line">    c.Conn.SetDeadline(time.Now().Add(<span class="number">30</span> * time.Second))</span><br><span class="line">    <span class="keyword">defer</span> c.Conn.SetDeadline(time.Time&#123;&#125;) <span class="comment">// Disable the deadline</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> state.downloaded &lt; pw.length &#123;</span><br><span class="line">        <span class="comment">// If unchoked, send requests until we have enough unfulfilled requests</span></span><br><span class="line">        <span class="keyword">if</span> !state.client.Choked &#123;</span><br><span class="line">            <span class="keyword">for</span> state.backlog &lt; MaxBacklog &amp;&amp; state.requested &lt; pw.length &#123;</span><br><span class="line">                blockSize := MaxBlockSize</span><br><span class="line">                <span class="comment">// Last block might be shorter than the typical block</span></span><br><span class="line">                <span class="keyword">if</span> pw.length-state.requested &lt; blockSize &#123;</span><br><span class="line">                    blockSize = pw.length - state.requested</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                err := c.SendRequest(pw.index, state.requested, blockSize)</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">                &#125;</span><br><span class="line">                state.backlog++</span><br><span class="line">                state.requested += blockSize</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        err := state.readMessage()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state.buf, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h3><blockquote><p>This is a short one. We’re almost there.</p></blockquote><p>这是一个简短的问题。我们快要到达目标了。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/veggiedefender/torrent-client/torrentfile&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    inPath := os.Args[<span class="number">1</span>]</span><br><span class="line">    outPath := os.Args[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    tf, err := torrentfile.Open(inPath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = tf.DownloadToFile(outPath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="This-isn’t-the-full-story"><a href="#This-isn’t-the-full-story" class="headerlink" title="This isn’t the full story"></a>This isn’t the full story</h2><blockquote><p>For brevity, I included only a few of the important snippets of code. Notably, I left out all the glue code, parsing, unit tests, and the boring parts that build character. View my <a href="https://github.com/veggiedefender/torrent-client">full implementation</a> if you’re interested.</p></blockquote><p>为了简洁起见，我只包含了一些重要的代码片段。值得注意的是，我省略了所有的粘合代码、解析、单元测试以及构建角色的无聊部分。如果你有兴趣，可以查看我的完整实现。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h2&gt;&lt;p&gt;最近看到一个项目 &lt;a href=&quot;https://github.com/codecrafters-io/build-your-own-x&quot;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>学习数据库的方法</title>
    <link href="https://anarckk.github.io/2023/08/16/2023-08/%E5%AD%A6%E4%B9%A0%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <id>https://anarckk.github.io/2023/08/16/2023-08/%E5%AD%A6%E4%B9%A0%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95/</id>
    <published>2023-08-16T13:42:00.000Z</published>
    <updated>2023-08-16T13:46:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>纸上得来终觉浅，觉知此事要躬行</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;纸上得来终觉浅，觉知此事要躬行&lt;/p&gt;
</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>制作vscode远程容器开发镜像(支持docker和k8s远程容器开发)</title>
    <link href="https://anarckk.github.io/2023/08/15/2023-08/%E5%88%B6%E4%BD%9Cvscode%E8%BF%9C%E7%A8%8B%E5%AE%B9%E5%99%A8%E5%BC%80%E5%8F%91%E9%95%9C%E5%83%8F/"/>
    <id>https://anarckk.github.io/2023/08/15/2023-08/%E5%88%B6%E4%BD%9Cvscode%E8%BF%9C%E7%A8%8B%E5%AE%B9%E5%99%A8%E5%BC%80%E5%8F%91%E9%95%9C%E5%83%8F/</id>
    <published>2023-08-15T02:36:13.000Z</published>
    <updated>2023-08-15T03:58:28.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="为什么要弄远程容器开发镜像"><a href="#为什么要弄远程容器开发镜像" class="headerlink" title="为什么要弄远程容器开发镜像"></a>为什么要弄远程容器开发镜像</h2><ol><li>越来越少的时间在自己家里搞机，总是东走西走，电脑也不一定用自己的，所以，在一个新地方就重新搭环境，不合理。</li><li>机器多了，可以折腾</li><li>巨硬的vscode太好用了，java，golang, nodejs全部可以在上面开发</li></ol><h2 id="远程开发镜像中有什么"><a href="#远程开发镜像中有什么" class="headerlink" title="远程开发镜像中有什么"></a>远程开发镜像中有什么</h2><p>java开发环境，golang开发环境，nodejs开发环境<br>同时支持docker内嵌docker</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ol><li>搭建一个ng服务，提前缓存好jdk等软件，加速构建过程，局域网dns: ng-dev-dependency.bee.anarckk.me</li><li>搭建好verdaccio，这个适合我用，别人不一定需要，局域网dns: verdaccio.bee.anarckk.me</li><li>内网弄好dns解析，软路由上配一下就行</li></ol><h2 id="制作基础镜像fh-dev"><a href="#制作基础镜像fh-dev" class="headerlink" title="制作基础镜像fh-dev"></a>制作基础镜像fh-dev</h2><h3 id="dockerfile"><a href="#dockerfile" class="headerlink" title="dockerfile"></a>dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> bee.anarckk.me:<span class="number">5000</span>/anarckk/ubuntu:<span class="number">20.04</span>-git2.<span class="number">24.0</span>-docker20.<span class="number">10.19</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> NG_DEV_DEPENDENCY=ng-dev-dependency.bee.anarckk.me</span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/jdk1.<span class="number">8.0</span>_371</span><br><span class="line"><span class="keyword">ENV</span> MAVEN_HOME /usr/local/apache-maven-<span class="number">3.9</span>.<span class="number">3</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">&quot;$&#123;PATH&#125;:/usr/local/go/bin:/usr/local/node-v18.16.0-linux-x64/bin:$&#123;MAVEN_HOME&#125;/bin:$&#123;JAVA_HOME&#125;/bin:/usr/local/gradle-8.2.1/bin&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> GOPROXY https://proxy.golang.com.cn </span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 gradle</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;install gradle&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">cd</span> /usr/local \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; curl -L -O http://<span class="variable">$&#123;NG_DEV_DEPENDENCY&#125;</span>/gradle/gradle-8.2.1-bin.zip \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; unzip gradle-8.2.1-bin.zip \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf gradle-8.2.1-bin.zip \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 安装 maven</span></span></span><br><span class="line">    &amp;&amp; echo <span class="string">&#x27;install maven&#x27;</span> \</span><br><span class="line">    &amp;&amp; cd /usr/local \</span><br><span class="line">    &amp;&amp; curl -L -O http://$&#123;NG_DEV_DEPENDENCY&#125;/apache-maven-<span class="number">3.9</span>.<span class="number">3</span>-bin.tar.gz \</span><br><span class="line">    &amp;&amp; tar xzf apache-maven-<span class="number">3.9</span>.<span class="number">3</span>-bin.tar.gz \</span><br><span class="line">    &amp;&amp; rm -rf apache-maven-<span class="number">3.9</span>.<span class="number">3</span>-bin.tar.gz \</span><br><span class="line">    <span class="comment"># 安装 java8</span></span><br><span class="line">    &amp;&amp; echo <span class="string">&#x27;install java8&#x27;</span> \</span><br><span class="line">    &amp;&amp; curl -L -O http://$&#123;NG_DEV_DEPENDENCY&#125;/jdk-<span class="number">8</span>u371-linux-x64.tar.gz \</span><br><span class="line">    &amp;&amp; tar zxf jdk-<span class="number">8</span>u371-linux-x64.tar.gz \</span><br><span class="line">    &amp;&amp; rm -rf jdk-<span class="number">8</span>u371-linux-x64.tar.gz \</span><br><span class="line">    <span class="comment"># 安装 java17</span></span><br><span class="line">    &amp;&amp; echo <span class="string">&#x27;install java17&#x27;</span> \</span><br><span class="line">    &amp;&amp; curl -L -O http://$&#123;NG_DEV_DEPENDENCY&#125;/openjdk-<span class="number">17.0</span>.<span class="number">2</span>_linux-x64_bin.tar.gz \</span><br><span class="line">    &amp;&amp; tar zxf openjdk-<span class="number">17.0</span>.<span class="number">2</span>_linux-x64_bin.tar.gz \</span><br><span class="line">    &amp;&amp; rm -rf openjdk-<span class="number">17.0</span>.<span class="number">2</span>_linux-x64_bin.tar.gz \</span><br><span class="line">    <span class="comment"># 安装 nodejs</span></span><br><span class="line">    &amp;&amp; echo <span class="string">&#x27;install nodejs&#x27;</span> \</span><br><span class="line">    &amp;&amp; cd /usr/local \</span><br><span class="line">    &amp;&amp; curl -L -O http://$&#123;NG_DEV_DEPENDENCY&#125;/node-v18.<span class="number">16.0</span>-linux-x64.tar.xz \</span><br><span class="line">    &amp;&amp; tar -xvf node-v18.<span class="number">16.0</span>-linux-x64.tar.xz \</span><br><span class="line">    &amp;&amp; rm -rf node-v18.<span class="number">16.0</span>-linux-x64.tar.xz \</span><br><span class="line">    &amp;&amp; echo <span class="string">&#x27;install npm@^9.7.2&#x27;</span> \</span><br><span class="line">    &amp;&amp; npm install -g npm@^<span class="number">9.7</span>.<span class="number">2</span> \</span><br><span class="line">    &amp;&amp; echo <span class="string">&#x27;install nrm&#x27;</span> \</span><br><span class="line">    &amp;&amp; npm i -g nrm open@<span class="number">8.4</span>.<span class="number">2</span> --save \</span><br><span class="line">    &amp;&amp; nrm <span class="keyword">add</span><span class="language-bash"> verdaccio http://verdaccio.bee.anarckk.me/ \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; nrm use verdaccio \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;install yarn&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; npm install -g yarn@^1.22.19 \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 安装 golang</span></span></span><br><span class="line">    &amp;&amp; echo <span class="string">&#x27;install golang&#x27;</span> \</span><br><span class="line">    &amp;&amp; cd /usr/local \</span><br><span class="line">    &amp;&amp; curl -L -O http://$&#123;NG_DEV_DEPENDENCY&#125;/go1.<span class="number">20.4</span>.linux-amd64.tar.gz \</span><br><span class="line">    &amp;&amp; rm -rf /usr/local/go \</span><br><span class="line">    &amp;&amp; tar -C /usr/local -xzf go1.<span class="number">20.4</span>.linux-amd64.tar.gz \</span><br><span class="line">    &amp;&amp; rm -rf go1.<span class="number">20.4</span>.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [ <span class="string">&quot;/root/.vscode-server&quot;</span>, <span class="string">&quot;/root/.m2&quot;</span>, <span class="string">&quot;/root/.ssh&quot;</span>,<span class="string">&quot;/root/go/pkg&quot;</span>, <span class="string">&quot;/root/go/bin&quot;</span>, <span class="string">&quot;/root/.npm&quot;</span> ] </span></span><br></pre></td></tr></table></figure><h3 id="构建命令"><a href="#构建命令" class="headerlink" title="构建命令"></a>构建命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t bee.anarckk.me:5000/anarckk/fh-dev:latest . \</span><br><span class="line">&amp;&amp; docker push bee.anarckk.me:5000/anarckk/fh-dev:latest</span><br></pre></td></tr></table></figure><h3 id="已推送到dockerhub上"><a href="#已推送到dockerhub上" class="headerlink" title="已推送到dockerhub上"></a>已推送到dockerhub上</h3><p><a href="https://hub.docker.com/repository/docker/anarckk/fh-dev">https://hub.docker.com/repository/docker/anarckk/fh-dev</a></p><h2 id="在基础镜像上制作业务镜像"><a href="#在基础镜像上制作业务镜像" class="headerlink" title="在基础镜像上制作业务镜像"></a>在基础镜像上制作业务镜像</h2><h3 id="dockerfile-1"><a href="#dockerfile-1" class="headerlink" title="dockerfile"></a>dockerfile</h3><p>业务镜像主要在基础镜像上增加自定义maven配置，自定义golang的私有依赖仓库配置</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> bee.anarckk.me:<span class="number">5000</span>/anarckk/fh-dev:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> GIT_NAME=michael</span><br><span class="line"><span class="keyword">ARG</span> GIT_EMAIL=michael@gmail.com</span><br><span class="line"><span class="comment"># mavne的配置文件</span></span><br><span class="line"><span class="keyword">ARG</span> MVN_SETTINGS=settings.xml</span><br><span class="line"><span class="keyword">ENV</span> GOINSECURE gogs.bee.anarckk.me</span><br><span class="line"><span class="keyword">ENV</span> GONOPROXY gogs.bee.anarckk.me</span><br><span class="line"><span class="keyword">ENV</span> GONOSUMDB gogs.bee.anarckk.me</span><br><span class="line"><span class="keyword">ENV</span> GOPRIVATE gogs.bee.anarckk.me</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git config --global user.name <span class="variable">$GIT_NAME</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; git config --global user.email <span class="variable">$GIT_EMAIL</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">ln</span> -s /usr/bin/python3 /usr/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;MVN_SETTINGS&#125;</span> /usr/local/apache-maven-3.9.3/conf/settings.xml</span></span><br></pre></td></tr></table></figure><h3 id="构建命令-1"><a href="#构建命令-1" class="headerlink" title="构建命令"></a>构建命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker build --no-cache -t bee.anarckk.me:5000/anarckk/my-dev2:latest \</span><br><span class="line">  --build-arg GIT_NAME=anarckk \</span><br><span class="line">  --build-arg GIT_EMAIL=anarckk@gmail.com \</span><br><span class="line">  --build-arg MVN_SETTINGS=settings.xml . \</span><br><span class="line">&amp;&amp; docker push bee.anarckk.me:5000/anarckk/my-dev2:latest</span><br></pre></td></tr></table></figure><h3 id="docker-compose-yaml运行脚本"><a href="#docker-compose-yaml运行脚本" class="headerlink" title="docker-compose.yaml运行脚本"></a>docker-compose.yaml运行脚本</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">my-dev2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">bee.anarckk.me:5000/anarckk/my-dev2:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">my-dev2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">custom-bridge:</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/workdir/data2/dev/my-dev/workspace:/workdir/data2/dev/my-dev/workspace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./vscode-server:/root/.vscode-server</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">../common/m2:/root/.m2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">../common/ssh:/root/.ssh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">../common/pkg:/root/go/pkg</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">../common/go-bin:/root/go/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">../common/npm-cache:/root/.npm</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/timezone:/etc/timezone:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&quot;10m&quot;</span></span><br><span class="line">    <span class="attr">stdin_open:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">&quot;root&quot;</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">custom-bridge:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="同时，这个镜像那个可以k8s远程容器开发"><a href="#同时，这个镜像那个可以k8s远程容器开发" class="headerlink" title="同时，这个镜像那个可以k8s远程容器开发"></a>同时，这个镜像那个可以k8s远程容器开发</h2><p>这个技术学会的太晚了，早一年学会这个技术，就不用telepresence折腾的麻烦，远程到容器中开发，对于调试k8s二开的应用来说，方便的很。</p><p>k8s1-dev.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s1-dev-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">finalizers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">k8s1-dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s1-dev</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">k8s1-dev-ns</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s1-dev</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">k8s1-dev-ns</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">k8s1-dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s1-dev</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">bee.anarckk.me:5000/anarckk/my-dev2:latest</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/workdir/data1/k8s1-dev/workspace</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">workspace</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/root/.vscode-server</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">vscode-server</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/root/go/pkg</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">go-pkg</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/root/go/bin</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">go-bin</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/root/.ssh</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ssh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/root/.kube</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">3Gi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s1</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">workspace</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/workdir/data1/k8s1-dev/workspace</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vscode-server</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/workdir/data1/k8s1-dev/common/vscode-server</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">go-pkg</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/workdir/data1/k8s1-dev/common/go-pkg</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">go-bin</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/workdir/data1/k8s1-dev/common/go-bin</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssh</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/workdir/data1/k8s1-dev/common/ssh</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/workdir/data1/k8s1-dev/common/.kube</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">  <span class="comment">#- name: docker</span></span><br><span class="line">  <span class="comment">#  hostPath:</span></span><br><span class="line">  <span class="comment">#    path: /var/lib/docker</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">k8s1-dev</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s1-dev-admin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s1-dev</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">k8s1-dev-ns</span></span><br></pre></td></tr></table></figure><p>运行这个脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f k8s1-dev.yaml</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;为什么要弄远程容器开发镜像&quot;&gt;&lt;a href=&quot;#为什么要弄远程容器开发镜像&quot; class=&quot;headerlink&quot; title=&quot;为什么要弄远程容器开发镜像&quot;&gt;&lt;/a&gt;为什么要弄远程容器开发镜像&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;越来越少的时间在自己家里搞机，总是东走西</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>重新恢复搭建hexo的过程</title>
    <link href="https://anarckk.github.io/2023/06/20/2023-6/%E6%90%AD%E5%BB%BAhexo%E7%9A%84%E8%BF%87%E7%A8%8B/"/>
    <id>https://anarckk.github.io/2023/06/20/2023-6/%E6%90%AD%E5%BB%BAhexo%E7%9A%84%E8%BF%87%E7%A8%8B/</id>
    <published>2023-06-20T01:21:54.000Z</published>
    <updated>2023-06-20T09:09:51.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以前hexo像是在玩一样，只是随便弄一弄。自从私有云服务器没了，就再没搞过hexo博客.</p><p>但是现在发现 material-x 已经变成了 volantis 升级更新的很好，所以这次想放到github page上做永久发布。</p><p><a href="https://zhuanlan.zhihu.com/p/603658639">知乎 - hexo-butterfly主题-giscus评论系统设置</a><br><a href="https://zhuanlan.zhihu.com/p/392900543">知乎 - 【hexo】基础教程-四-新增RSS订阅</a>  </p><p><a href="https://giscus.app/zh-CN">giscus</a>  </p><h2 id="增加rss订阅"><a href="#增加rss订阅" class="headerlink" title="增加rss订阅"></a>增加rss订阅</h2><p>运行：<code>npm install --save hexo-generator-feed</code></p><p>然后修改文件 _config.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Extensions</span></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="string">hexo-generator-feed</span></span><br><span class="line"><span class="comment">#Feed Atom</span></span><br><span class="line"><span class="attr">feed:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">atom</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">atom.xml</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure><p>然后就可以了，<code>npm run build</code>完了之后，就可以用了。</p><p>参考: <a href="https://zhuanlan.zhihu.com/p/392900543">知乎 - 【hexo】基础教程-四-新增RSS订阅</a>  </p><h2 id="开启搜索服务"><a href="#开启搜索服务" class="headerlink" title="开启搜索服务"></a>开启搜索服务</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################### Search ############################### &gt; start</span></span><br><span class="line"><span class="comment"># To use hexo search, you need to install the following plugins:</span></span><br><span class="line"><span class="comment"># npm i hexo-generator-json-content</span></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">hexo</span>  <span class="comment"># hexo</span></span><br><span class="line">  <span class="attr">js:</span></span><br><span class="line"><span class="comment">############################### Search ############################### &gt; end</span></span><br></pre></td></tr></table></figure><p>根据这个配置来，在 _config.volantis.yml ，先执行命令，再放一下这个配置，就OK了</p><h2 id="配置giscus评论系统"><a href="#配置giscus评论系统" class="headerlink" title="配置giscus评论系统"></a>配置giscus评论系统</h2><p>_config.volantis.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#############################################################################################</span></span><br><span class="line"><span class="attr">comments:</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">giscus</span></span><br><span class="line">  <span class="comment"># giscus</span></span><br><span class="line">  <span class="comment"># https://giscus.app</span></span><br><span class="line">  <span class="comment"># https://github.com/laymonage/giscus</span></span><br><span class="line">  <span class="attr">giscus:</span></span><br><span class="line">    <span class="comment"># 以下配置按照 yml 格式增删填写即可</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">anarckk/giscus</span></span><br><span class="line">    <span class="attr">repo-id:</span> <span class="string">R_kgDOJxkH0w</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">Announcements</span></span><br><span class="line">    <span class="attr">category-id:</span> <span class="string">DIC_kwDOJxkH084CXU85</span></span><br><span class="line">    <span class="attr">mapping:</span> <span class="string">&quot;url&quot;</span></span><br><span class="line">    <span class="attr">reactions-enabled:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">emit-metadata:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">lang:</span> <span class="string">&quot;zh-CN&quot;</span></span><br><span class="line">    <span class="comment"># 以上配置按照 yml 格式增删填写即可</span></span><br><span class="line">    <span class="attr">theme:</span></span><br><span class="line">      <span class="attr">light:</span> <span class="string">&quot;light&quot;</span> <span class="comment"># https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@master/css/giscus/light.css</span></span><br><span class="line">      <span class="attr">dark:</span> <span class="string">&quot;dark&quot;</span> <span class="comment"># https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@master/css/giscus/dark.css</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################################################################</span></span><br></pre></td></tr></table></figure><p>参考：</p><p><a href="https://zhuanlan.zhihu.com/p/603658639">知乎 - hexo-butterfly主题-giscus评论系统设置</a>  </p><p><a href="https://giscus.app/zh-CN">giscus</a>  </p><h2 id="增加用户配置"><a href="#增加用户配置" class="headerlink" title="增加用户配置"></a>增加用户配置</h2><p>参考资料：<a href="https://volantis.js.org/v5/advanced-settings/?keyword=author">https://volantis.js.org/v5/advanced-settings/?keyword=author</a></p><p>增加文件 source&#x2F;_data&#x2F;author.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Anarckk:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">Anarckk</span></span><br><span class="line">  <span class="attr">avatar:</span> <span class="string">https://cn.bing.com/th?id=AMMS_fc8f99fd41ebd737a71c4e13806db9a0&amp;w=110&amp;h=110&amp;c=7&amp;rs=1&amp;qlt=80&amp;pcl=f9f9f9&amp;cdv=1&amp;dpr=2&amp;pid=16.1</span></span><br><span class="line">  <span class="attr">url:</span> </span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;以前hexo像是在玩一样，只是随便弄一弄。自从私有云服务器没了，就再没搞过hexo博客.&lt;/p&gt;
&lt;p&gt;但是现在发现 material-x </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>解决excel文件下载乱码问题</title>
    <link href="https://anarckk.github.io/2020/01/15/2020-1/15-%E8%A7%A3%E5%86%B3excel%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98/"/>
    <id>https://anarckk.github.io/2020/01/15/2020-1/15-%E8%A7%A3%E5%86%B3excel%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98/</id>
    <published>2020-01-15T08:38:39.000Z</published>
    <updated>2023-06-20T07:44:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>　　今天遇到一个excel下载乱码问题，从服务器上使用流下载方式，用jquery.ajax下载之后，再转成blob使用虚拟节点下载客户端。然后一直乱码。找了很多方法，包括服务器指定 response.setCharacterEncoding(“utf-8”); 客户端再使用 charset&#x3D;utf-8 指定编码。再或者从 ms-excel 到修改为 octet-stream ，各种组合都无效。烦了一下午。终于找到了一篇博客 <a href="https://www.jb51.net/article/88972.htm">jQuery的ajax下载blob文件</a> ，很显然这篇博客被抄来抄去。也就不转载了，自己搜吧以后。这篇博客提供了一个思路，ajax在底层自动将数据转型为字符串，而且编码不被控制。这也就是为什么我自己制定编码都无效的原因，因为我没有指定ajax底层的编码方式。</p><span id="more"></span><p><strong>旧代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    type: method,</span><br><span class="line">    data: JSON.stringify(data),</span><br><span class="line">    url: <span class="string">&quot;http://localhost:8096&quot;</span> + url,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;).done(function (data, status, jqXHR) &#123;</span><br><span class="line">    console.log(data <span class="keyword">instanceof</span> Blob);</span><br><span class="line">    <span class="type">var</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">    reader.readAsText(<span class="keyword">new</span> <span class="title class_">Blob</span>([data]), <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    reader.onload = function (evt) &#123;</span><br><span class="line">        console.log(evt);</span><br><span class="line">        <span class="type">const</span> <span class="variable">url</span> <span class="operator">=</span> window.URL.createObjectURL(<span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="string">&#x27;\uFEFF&#x27;</span> + evt.target.result], &#123;type: <span class="string">&#x27;application/ms-excel;charset=utf-8&#x27;</span>&#125;));</span><br><span class="line">        <span class="type">const</span> <span class="variable">link</span> <span class="operator">=</span> document.createElement(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        link.href = url;</span><br><span class="line">        link.setAttribute(<span class="string">&#x27;download&#x27;</span>, <span class="string">&#x27;名片印刷导出.xls&#x27;</span>);</span><br><span class="line">        document.body.appendChild(link);</span><br><span class="line">        link.click();</span><br><span class="line">        URL.revokeObjectURL(link.href);</span><br><span class="line">        document.body.removeChild(link);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>　　本着这个思路，就用 XMLHttpRequest 替代掉了 ajax ，没想到马上就解决了。真的是坑</p><p><strong>有效的代码</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="string">&quot;/businessCard/excelBusinessCard&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> method = <span class="string">&quot;POST&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> data = &#123;</span><br><span class="line">    <span class="string">&quot;applicantId&quot;</span>: <span class="title function_">getUserId</span>(),</span><br><span class="line">    <span class="string">&quot;pageNo&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;pageSize&quot;</span>: <span class="number">10000</span></span><br><span class="line">&#125;;</span><br><span class="line">data.<span class="property">token</span> = <span class="title function_">getToken</span>();</span><br><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">xhr.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>,  <span class="string">&quot;http://localhost:8096&quot;</span> + url, <span class="literal">true</span>);    <span class="comment">// 也可以使用POST方式，根据接口</span></span><br><span class="line">xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&#x27;application/json&#x27;</span>);</span><br><span class="line">xhr.<span class="property">responseType</span> = <span class="string">&quot;blob&quot;</span>;  <span class="comment">// 返回类型blob</span></span><br><span class="line"><span class="comment">// 定义请求完成的处理函数，请求前也可以增加加载框/禁用下载按钮逻辑</span></span><br><span class="line">xhr.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 请求完成</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="comment">// 返回200</span></span><br><span class="line">        <span class="keyword">var</span> blob = <span class="variable language_">this</span>.<span class="property">response</span>;</span><br><span class="line">        <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">        reader.<span class="title function_">readAsDataURL</span>(blob);  <span class="comment">// 转换为base64，可以直接放入a表情href</span></span><br><span class="line">        reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="comment">// 转换完成，创建一个a标签用于下载</span></span><br><span class="line">            <span class="keyword">var</span> a = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">            a.<span class="property">download</span> = <span class="string">&#x27;data.xls&#x27;</span>;</span><br><span class="line">            a.<span class="property">href</span> = e.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">            $(<span class="string">&quot;body&quot;</span>).<span class="title function_">append</span>(a);  <span class="comment">// 修复firefox中无法触发click</span></span><br><span class="line">            a.<span class="title function_">click</span>();</span><br><span class="line">            $(a).<span class="title function_">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 发送ajax请求</span></span><br><span class="line">xhr.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;　　今天遇到一个excel下载乱码问题，从服务器上使用流下载方式，用jquery.ajax下载之后，再转成blob使用虚拟节点下载客户端。然后一直乱码。找了很多方法，包括服务器指定 response.setCharacterEncoding(“utf-8”); 客户端再使用 charset&amp;#x3D;utf-8 指定编码。再或者从 ms-excel 到修改为 octet-stream ，各种组合都无效。烦了一下午。终于找到了一篇博客 &lt;a href=&quot;https://www.jb51.net/article/88972.htm&quot;&gt;jQuery的ajax下载blob文件&lt;/a&gt; ，很显然这篇博客被抄来抄去。也就不转载了，自己搜吧以后。这篇博客提供了一个思路，ajax在底层自动将数据转型为字符串，而且编码不被控制。这也就是为什么我自己制定编码都无效的原因，因为我没有指定ajax底层的编码方式。&lt;/p&gt;</summary>
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="excel" scheme="https://anarckk.github.io/tags/excel/"/>
    
  </entry>
  
  <entry>
    <title>Character类检查码点一个char放不放的下</title>
    <link href="https://anarckk.github.io/2020/01/10/2020-1/10-Character%E7%B1%BB%E6%A3%80%E6%9F%A5%E7%A0%81%E7%82%B9%E4%B8%80%E4%B8%AAchar%E6%94%BE%E4%B8%8D%E6%94%BE%E7%9A%84%E4%B8%8B/"/>
    <id>https://anarckk.github.io/2020/01/10/2020-1/10-Character%E7%B1%BB%E6%A3%80%E6%9F%A5%E7%A0%81%E7%82%B9%E4%B8%80%E4%B8%AAchar%E6%94%BE%E4%B8%8D%E6%94%BE%E7%9A%84%E4%B8%8B/</id>
    <published>2020-01-10T01:02:26.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>　　在java中，一个char是2个字节，用utf-16进行编码。一个字符可以转为数字，我猜称为码点(codePoint)。Character里有个方法可以检查，一个码点要用几个char来放。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果一个字符用utf-8编码，那么它就有3个字节。</span></span><br><span class="line"><span class="comment"> * 这个函数检查，2个字节能不能放的下codePoint码点的字符</span></span><br><span class="line"><span class="comment"> * 放的下返回1，放不下返回2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">charCount</span><span class="params">(<span class="type">int</span> codePoint)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> codePoint &gt;= MIN_SUPPLEMENTARY_CODE_POINT ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;　　在java中，一个char是2个字节，用utf-16进行编码。一个字符可以转为数字，我猜称为码点(codePoint)。Character里有个方法可以检查，一个码点要用几个char来放。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;tabl</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="JAVA" scheme="https://anarckk.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>java 依赖、组合、聚合与继承</title>
    <link href="https://anarckk.github.io/2020/01/09/2020-1/09-java-%E4%BE%9D%E8%B5%96%E3%80%81%E7%BB%84%E5%90%88%E3%80%81%E8%81%9A%E5%90%88%E4%B8%8E%E7%BB%A7%E6%89%BF/"/>
    <id>https://anarckk.github.io/2020/01/09/2020-1/09-java-%E4%BE%9D%E8%B5%96%E3%80%81%E7%BB%84%E5%90%88%E3%80%81%E8%81%9A%E5%90%88%E4%B8%8E%E7%BB%A7%E6%89%BF/</id>
    <published>2020-01-09T05:20:36.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>类之间的关系大体上存在五种—继承(实现)、依赖、关联、聚合、组合。</p><h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h4><p>继承是一种“is-a”关系。多了就不说了，都懂得。</p><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><p>依赖简单的理解，就是一个类A中的方法使用到了另一个类B。</p><p>这种使用关系是具有偶然性的、临时性的、非常弱的，但是B类的变化会影响到A。</p><p>比如说，我用笔写字，首先需要一个类来代表我自己，然后需要一个类来代表一支笔，最后，‘我’要调用‘笔’里的方法来写字，用代码实现一下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pen</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;use pen to write&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Me</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(Pen pen)</span>&#123;<span class="comment">//这里，pen作为Me类方法的参数。  Me类依赖Pen类</span></span><br><span class="line">        pen.write();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到这大家都懂了，因为这种代码你每天都会写。现在你知道了，这就是一种类与类之间的关系，叫做依赖。</p><p>这种关系是一种很弱的关系，但是pen类的改变，有可能会影响到Me类的结果，比如我把pen类write方法的方法体改了，me中再调用就会得到不同的结果。</p><p><strong>一般而言，依赖关系在Java中体现为局域变量、方法的形参，或者对静态方法的调用。</strong></p><h4 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h4><p>关联体现的是两个类、或者类与接口之间语义级别的一种强依赖关系。</p><p>这种关系比依赖更强、不存在依赖关系的偶然性、关系也不是临时性的，一般是长期性的，而且双方的关系一般是平等的、关联可以是单向、双向的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pen 还是上面的pen</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">You</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Pen pen; <span class="comment">// 让pen成为you的类属性 </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">You</span><span class="params">(Pen p)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.pen = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span>&#123;</span><br><span class="line">        pen.write();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>被关联类B以类属性的形式出现在关联类A中，或者关联类A引用了一个类型为被关联类B的全局变量的这种关系，就叫关联关系。</p><p><strong>在Java中，关联关系一般使用成员变量来实现。</strong></p><h4 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h4><p>聚合是关联关系的一种特例，他体现的是整体与部分、拥有的关系，即has-a的关系</p><p>看下面一段代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Family</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Child&gt; children; <span class="comment">//一个家庭里有许多孩子</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在代码层面，聚合和关联关系是一致的，只能从语义级别来区分。普通的关联关系中，a类和b类没有必然的联系，而聚合中，需要b类是a类的一部分，是一种”has-a“的关系，即 a has-a b; 比如家庭有孩子，屋子里有空调。</p><p>但是，has 不是 must has，a可以有b，也可以没有。a是整体，b是部分，整体与部分之间是可分离的，他们可以具有各自的生命周期，部分可以属于多个整体对象，也可以为多个整体对象共享。</p><p><strong>不同于关联关系的平等地位，聚合关系中两个类的地位是不平等。</strong></p><h4 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h4><p>组合也是关联关系的一种特例，他体现的是一种contains-a的关系，这种关系比聚合更强，也称为强聚合。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Eye</span> <span class="variable">eye</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Eye</span>();  <span class="comment">//一个人有鼻子有眼睛</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Nose</span> <span class="variable">nose</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Nose</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>组合同样体现整体与部分间的关系，但此时整体与部分是不可分的，整体的生命周期结束也就意味着部分的生命周期结束。</p><p>就像你有鼻子有眼睛，如果你一不小心结束了生命周期，鼻子和眼睛的生命周期也会结束，而且，鼻子和眼睛不能脱离你单独存在。</p><p>只看代码，你是无法区分关联，聚合和组合的，具体是哪一种关系，只能从语义级别来区分。</p><p><strong>同样，组合关系中，两个类关系也是不平等的。</strong></p><h4 id="组合，聚合和继承"><a href="#组合，聚合和继承" class="headerlink" title="组合，聚合和继承"></a>组合，聚合和继承</h4><p>依赖关系是每一个java程序都离不开的，所以就不单独讨论了，普通的关联关系也没有什么特殊的地方，下面我们重点研究一下组合，聚合和继承。</p><h5 id="聚合与组合"><a href="#聚合与组合" class="headerlink" title="聚合与组合"></a>聚合与组合</h5><p>聚合与组合都是一种关联关系，只是额外具有整体-部分的意义。</p><p>部件的生命周期不同</p><p>聚合关系中，整件不会拥有部件的生命周期，所以整件删除时，部件不会被删除。再者，多个整件可以共享同一个部件。</p><p>组合关系中，整件拥有部件的生命周期，所以整件删除时，部件一定会跟着删除。而且，多个整件不可以同时间共享同一个部件。</p><p><strong>这个区别可以用来区分某个关联关系到底是组合还是聚合。两个类生命周期不同步，则是聚合关系，生命周期同步就是组合关系。</strong></p><p>聚合关系是【has-a】关系，组合关系是【contains-a】关系</p><p>平时我们只讨论组合和继承的时候，认为组合是【has-a 】关系，而事实上，聚合才是真正的【has-a】关系，组合是更深层次的【contains-a】关系。</p><p>由于【contains-a】关系是一种更深的【has-a】关系，所以说组合是【has-a】关系也是正确的。</p><h5 id="组合和继承"><a href="#组合和继承" class="headerlink" title="组合和继承"></a>组合和继承</h5><p>这个才是本文的重点。</p><p>学过设计模式的都知道，要“少用继承，多用组合”，这究竟是为什么呢？</p><p>我们先来看一下组合和继承各自的优缺点：</p><p><strong>组合</strong></p><p>优点：</p><ul><li>不破坏封装，整体类与局部类之间松耦合，彼此相对独立</li><li>具有较好的可扩展性</li><li>支持动态组合。在运行时，整体对象可以选择不同类型的局部对象</li><li>整体类可以对局部类进行包装，封装局部类的接口，提供新的接口</li></ul><p>缺点：</p><ul><li>整体类不能自动获得和局部类同样的接口</li><li>创建整体类的对象时，需要创建所有局部类的对象</li></ul><p><strong>继承</strong></p><p>优点:</p><ul><li>子类能自动继承父类的接口</li><li>创建子类的对象时，无须创建父类的对象</li></ul><p>缺点：</p><ul><li>破坏封装，子类与父类之间紧密耦合，子类依赖于父类的实现，子类缺乏独立性</li><li>支持扩展，但是往往以增加系统结构的复杂度为代价</li><li>不支持动态继承。在运行时，子类无法选择不同的父类</li><li>子类不能改变父类的接口</li></ul><p>(后面罗里吧嗦的，不记了)</p><h4 id="参考来源"><a href="#参考来源" class="headerlink" title="参考来源"></a>参考来源</h4><p><a href="https://www.cnblogs.com/ccgjava/p/11433745.html">https://www.cnblogs.com/ccgjava/p/11433745.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;类之间的关系大体上存在五种—继承(实现)、依赖、关联、聚合、组合。&lt;/p&gt;
&lt;h4 id=&quot;继承&quot;&gt;&lt;a href=&quot;#继承&quot; class=&quot;headerlink&quot; title=&quot;继承&quot;&gt;&lt;/a&gt;继承&lt;/h4&gt;&lt;p&gt;继承是一种“is-a”关系。多了就不说了，都懂得。&lt;/p&gt;</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="JAVA" scheme="https://anarckk.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>shiro的组件架构</title>
    <link href="https://anarckk.github.io/2020/01/09/%E5%BD%92%E6%A1%A3/shiro/2020-01-09-shiro%E7%9A%84%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84/"/>
    <id>https://anarckk.github.io/2020/01/09/%E5%BD%92%E6%A1%A3/shiro/2020-01-09-shiro%E7%9A%84%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84/</id>
    <published>2020-01-09T03:29:50.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>Shiro主要组件包括：Subject，SecurityManager，Authenticator，Authorizer，SessionManager，CacheManager，Cryptography，Realms。</p><h3 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h3><p>Subject表示与系统交互的对象，可以是登录系统的操作用户，也可能是另外一个软件系统。<br>Subject类图：</p><img  src=http://www.plantuml.com/plantuml/svg/ZP1DJWCn38NtdC8xfelc24ZbPy6AYYAnzcJSZ6b8eiG59E00d8H3iE0sS0sI3fGPpIpgXVNq_Fd5Ia2zGKFWer4OKBUaKilHgxIjxqWBF1z1BdP2SOsQO3NmIrrrXY5PHdQQ0zfgjf_klJDlRUROkm6QUcpjlILqm6b9yPv5gAbMaaa3eHWfvUqntcAwpkeFZLbVDkI4rqpn7t_mt83rXbsrs4fR08tbdXk_8GTI-WoaZVunmP2uUD8KYfWujKVcSxldNdTTMqm9picIoIdE_7vTRtPBzNZSBH_30hu_th_UFk5qPqoneDJB2VHp3q0cW-RpJ8ti7m00><h3 id="SecurityManager"><a href="#SecurityManager" class="headerlink" title="SecurityManager"></a>SecurityManager</h3><p>SecurityManager是Shiro架构最核心的组件。实际上，SecurityManager就是Shiro框架的控制器，协调其他组件一起完成认证和授权，如下图所示：</p><img  src=http://www.plantuml.com/plantuml/svg/VOx13OCm34NlcS8Ba1qw09Ts0jSoITf28fCS07Lt0aX5WXGV_zVxVW7fZOR1Yz4Oa2phtZhnkZKH9WNvN1TP6YI61rCI5uSQkyo8-ghm3-_JyyLKcDZoArGOF-q9l2_f5OOfsl64tNBgnOshxS4VV5NzX4hTzhFKxBCp>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Shiro主要组件包括：Subject，SecurityManager，Authenticator，Authorizer，SessionManager，CacheManager，Cryptography，Realms。&lt;/p&gt;
&lt;h3 id=&quot;Subject&quot;&gt;&lt;a hre</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="shiro" scheme="https://anarckk.github.io/tags/shiro/"/>
    
  </entry>
  
  <entry>
    <title>在hexo中使用PlantUML来画UML</title>
    <link href="https://anarckk.github.io/2020/01/09/2020-1/09-%E5%9C%A8hexo%E4%B8%AD%E4%BD%BF%E7%94%A8PlantUML%E6%9D%A5%E7%94%BBUML/"/>
    <id>https://anarckk.github.io/2020/01/09/2020-1/09-%E5%9C%A8hexo%E4%B8%AD%E4%BD%BF%E7%94%A8PlantUML%E6%9D%A5%E7%94%BBUML/</id>
    <published>2020-01-09T03:20:28.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>　　<a href="https://plantuml.com/">PlantUML</a>使你轻松地从文字描述来生成UML，可谓UML中的MarkDown，支持时序图、用例图、类图、活动图、组件图、状态图、对象图、部署图等UML以及非UML图。在hexo中可以使用hexo-tag-plantuml插件来集成进来。这种方式画UML不仅快速和可控，还给后期维护带来了便捷性。</p><h4 id="java包"><a href="#java包" class="headerlink" title="java包"></a>java包</h4><p>　　它可以用java直接使用，下载jar包：<a href="https://sourceforge.net/projects/plantuml/files/plantuml.jar/download">plantuml.jar</a>。</p><p>　　描述文件demo.txt:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">start</span><br><span class="line">:配置Java环境; </span><br><span class="line">:下载pantuml.jar;</span><br><span class="line">:编写描述文件; </span><br><span class="line">:执行; </span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p>　　执行Jar</p><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar plantuml.jar demo.txt</span><br></pre></td></tr></table></figure><h4 id="hexo-plantuml插件"><a href="#hexo-plantuml插件" class="headerlink" title="hexo plantuml插件"></a>hexo plantuml插件</h4><p>安装插件</p><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-tag-plantuml --save</span><br></pre></td></tr></table></figure><p>语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% plantuml %&#125;</span><br><span class="line">    Bob-&gt;Alice : hello</span><br><span class="line">&#123;% endplantuml %&#125;</span><br></pre></td></tr></table></figure><img  src=http://www.plantuml.com/plantuml/svg/SyfFqhLppCbCJbMmKiX8pSd91m00><p>示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% plantuml %&#125;</span><br><span class="line">start</span><br><span class="line">:配置Java环境; </span><br><span class="line">:下载pantuml.jar;</span><br><span class="line">:编写描述文件; </span><br><span class="line">:执行; </span><br><span class="line">stop</span><br><span class="line">&#123;% endplantuml %&#125;</span><br></pre></td></tr></table></figure><p>效果如下：</p><img  src=http://www.plantuml.com/plantuml/svg/Aov9B2hXidhPsljyxpglnBB4vtthdovgjbRWidgoe_l5thq5YNabfRavUbc9HTPSLi_tJ7lQDlDPV_-B_HkUJMj_idiRIEMppkKl5lO0MSKb-GK0><h4 id="画图方法"><a href="#画图方法" class="headerlink" title="画图方法"></a>画图方法</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">继承（泛化）       --|&gt;</span><br><span class="line">接口继承           ..|&gt;</span><br><span class="line">接口实现           ..|&gt;</span><br><span class="line">依赖               ..&gt;</span><br><span class="line">关联               -</span><br><span class="line">直接关联           --&gt;</span><br><span class="line">聚合               o--</span><br><span class="line">组合               *--</span><br></pre></td></tr></table></figure><p>这篇教程已经写的很清楚了。如果以后没有不能用，就不会写它。<a href="https://plantuml.com/zh/class-diagram">https://plantuml.com/zh/class-diagram</a></p><p>还有这张图可以参考</p><p><img src="/assets/images/2020-01/09-UML%E7%AC%A6%E5%8F%B7.jpg" class="lazyload" data-srcset="/assets/images/2020-01/09-UML%E7%AC%A6%E5%8F%B7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h4 id="参考来源"><a href="#参考来源" class="headerlink" title="参考来源"></a>参考来源</h4><p>PlantUml画类图 <a href="https://www.jianshu.com/p/b65e8dca999d">https://www.jianshu.com/p/b65e8dca999d</a><br><a href="http://www.zhaiqianfeng.com/2017/05/hexo-plantuml.html">http://www.zhaiqianfeng.com/2017/05/hexo-plantuml.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;　　&lt;a href=&quot;https://plantuml.com/&quot;&gt;PlantUML&lt;/a&gt;使你轻松地从文字描述来生成UML，可谓UML中的MarkDown，支持时序图、用例图、类图、活动图、组件图、状态图、对象图、部署图等UML以及非UML图。在hexo中可以使用hexo</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="uml" scheme="https://anarckk.github.io/tags/uml/"/>
    
  </entry>
  
  <entry>
    <title>String.trim()</title>
    <link href="https://anarckk.github.io/2020/01/09/2020-1/09-String-trim/"/>
    <id>https://anarckk.github.io/2020/01/09/2020-1/09-String-trim/</id>
    <published>2020-01-09T00:52:36.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>函数签名</p><blockquote><p>public String trim();</p></blockquote><p>注释</p><blockquote><p>Returns a string whose value is this string, with any leading and trailing whitespace removed.<br>返回一个字符串它的值是它自身，移除前导和后缀空白字符</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;函数签名&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;public String trim();&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;注释&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Returns a string whose value is this string, w</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="JAVA" scheme="https://anarckk.github.io/tags/JAVA/"/>
    
    <category term="java api" scheme="https://anarckk.github.io/tags/java-api/"/>
    
  </entry>
  
  <entry>
    <title>给类制作标准文档</title>
    <link href="https://anarckk.github.io/2020/01/09/2020-1/09-%E7%BB%99%E7%B1%BB%E5%88%B6%E4%BD%9C%E6%A0%87%E5%87%86%E6%96%87%E6%A1%A3/"/>
    <id>https://anarckk.github.io/2020/01/09/2020-1/09-%E7%BB%99%E7%B1%BB%E5%88%B6%E4%BD%9C%E6%A0%87%E5%87%86%E6%96%87%E6%A1%A3/</id>
    <published>2020-01-09T00:36:05.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>现在发现，java学习更多是api接口学习。所以要学会把懂的接口写成文档。一个类，所在包，内部公开的api,api调用示例，讲解。这些都要有个标准。就这么定吧：只记录自己见到用到的api的用法，以及源码的英文翻译。和自己的见解。不做全面细致的api翻译，不去全面搞懂所有的api。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;现在发现，java学习更多是api接口学习。所以要学会把懂的接口写成文档。一个类，所在包，内部公开的api,api调用示例，讲解。这些都要有个标准。就这么定吧：只记录自己见到用到的api的用法，以及源码的英文翻译。和自己的见解。不做全面细致的api翻译，不去全面搞懂所有的a</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="JAVA" scheme="https://anarckk.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>shiro认证过程</title>
    <link href="https://anarckk.github.io/2020/01/08/%E5%BD%92%E6%A1%A3/shiro/2020-01-08-shiro%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B/"/>
    <id>https://anarckk.github.io/2020/01/08/%E5%BD%92%E6%A1%A3/shiro/2020-01-08-shiro%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B/</id>
    <published>2020-01-08T08:58:09.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Subject</span> <span class="variable">currentUser</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line"><span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(username, password);</span><br><span class="line">token.setRememberMe(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">　　currentUser.login(token);</span><br><span class="line">&#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;</span><br><span class="line">　　logger.error(String.format(<span class="string">&quot;user not found: %s&quot;</span>, username), e); <span class="comment">// 用户不存在</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IncorrectCredentialsException e) &#123;</span><br><span class="line">　　logger.error(String.format(<span class="string">&quot;incorrent credentials: %s&quot;</span>, username), e); <span class="comment">// 密码不正确</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (ConcurrentAccessException e) &#123;</span><br><span class="line">　　logger.error(String.format(<span class="string">&quot;user has been authenticated: %s&quot;</span>, username), e); <span class="comment">// 用户重复登录</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (AccountException e) &#123;</span><br><span class="line">　　logger.error(String.format(<span class="string">&quot;account except: %s&quot;</span>, username), e); <span class="comment">// 其他账户异常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="shiro" scheme="https://anarckk.github.io/tags/shiro/"/>
    
  </entry>
  
  <entry>
    <title>springboot访问命令行参数</title>
    <link href="https://anarckk.github.io/2020/01/08/2020-1/08-springboot%E8%AE%BF%E9%97%AE%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0/"/>
    <id>https://anarckk.github.io/2020/01/08/2020-1/08-springboot%E8%AE%BF%E9%97%AE%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0/</id>
    <published>2020-01-08T01:52:06.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>默认情况下，SpringApplication 将所有命令行选项参数（即以 – 开头的参数，比如 –server.port&#x3D;9000）转换为属性，并将它们添加到 Spring Environment 中。如之前所述，命令行属性始终优先于其他属性源。</p><p>如果您不希望将命令行属性添加到 Environment，可以使用 SpringApplication.setAddCommandLineProperties(false) 来禁用它们。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;默认情况下，SpringApplication 将所有命令行选项参数（即以 – 开头的参数，比如 –server.port&amp;#x3D;9000）转换为属性，并将它们添加到 Spring Environment 中。如之前所述，命令行属性始终优先于其他属性源。&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="SpringBoot" scheme="https://anarckk.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>mybatis按时间段搜索</title>
    <link href="https://anarckk.github.io/2020/01/07/2020-1/07-mybatis%E6%8C%89%E6%97%B6%E9%97%B4%E6%AE%B5%E6%90%9C%E7%B4%A2/"/>
    <id>https://anarckk.github.io/2020/01/07/2020-1/07-mybatis%E6%8C%89%E6%97%B6%E9%97%B4%E6%AE%B5%E6%90%9C%E7%B4%A2/</id>
    <published>2020-01-07T01:37:33.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vacate <span class="keyword">WHERE</span> create_time <span class="keyword">BETWEEN</span> <span class="string">&#x27;2020-1-1 00:00:00&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2020-1-7 09:18:00&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="mybatis-mapper"><a href="#mybatis-mapper" class="headerlink" title="mybatis mapper"></a>mybatis mapper</h3><p><img src="/assets/images/2020-01/07-mybatis%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6.jpg" class="lazyload" data-srcset="/assets/images/2020-01/07-mybatis%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;submitFrom != null and submitTo != null&quot;</span>&gt;</span></span><br><span class="line">  and create_time between #&#123;submitFrom&#125; and #&#123;submitTo&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--或者如下--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;startTime != null&quot;</span>&gt;</span></span><br><span class="line">    AND create_time <span class="symbol">&amp;gt;</span>= #&#123;startTime,jdbcType=TIMESTAMP&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;endTime != null&quot;</span>&gt;</span></span><br><span class="line">    AND create_time <span class="symbol">&amp;lt;</span>= #&#123;endTime,jdbcType=TIMESTAMP&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;mysql&quot;&gt;&lt;a href=&quot;#mysql&quot; class=&quot;headerlink&quot; title=&quot;mysql&quot;&gt;&lt;/a&gt;mysql&lt;/h3&gt;&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="mybatis" scheme="https://anarckk.github.io/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>MySQL 使用 ON UPDATE CURRENT_TIMESTAMP 自动更新 timestamp</title>
    <link href="https://anarckk.github.io/2020/01/06/2020-1/06-MySQL-%E4%BD%BF%E7%94%A8-ON-UPDATE-CURRENT-TIMESTAMP-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0-timestamp/"/>
    <id>https://anarckk.github.io/2020/01/06/2020-1/06-MySQL-%E4%BD%BF%E7%94%A8-ON-UPDATE-CURRENT-TIMESTAMP-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0-timestamp/</id>
    <published>2020-01-06T04:59:53.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">`create_time` timestamp not null default current_timestamp comment &#x27;创建时间&#x27;,</span><br><span class="line">`update_time` timestamp not null default current_timestamp on update current_timestamp comment &#x27;修改时间&#x27;,</span><br></pre></td></tr></table></figure><p>当执行update操作是，并且字段有ON UPDATE CURRENT_TIMESTAMP属性。则字段无论值有没有变化，它的值也会跟着更新为当前UPDATE操作时的时间。</p><p>timestamp的两个属性：CURRENT_TIMESTAMP 和ON UPDATE CURRENT_TIMESTAMP</p><ol><li>CURRENT_TIMESTAMP</li></ol><p>当要向数据库执行insert操作时，如果有个timestamp字段属性设为 CURRENT_TIMESTAMP，则无论这个字段有没有set值都插入当前系统时间  </p><ol start="2"><li>ON UPDATE CURRENT_TIMESTAMP<br>当执行update操作是，并且字段有ON UPDATE CURRENT_TIMESTAMP属性。则字段无论值有没有变化，它的值也会跟着更新为当前UPDATE操作时的时间。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="mysql" scheme="https://anarckk.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>永久激活idea2019.3</title>
    <link href="https://anarckk.github.io/2020/01/04/2020-1/04-%E6%B0%B8%E4%B9%85%E6%BF%80%E6%B4%BBidea2019-3/"/>
    <id>https://anarckk.github.io/2020/01/04/2020-1/04-%E6%B0%B8%E4%B9%85%E6%BF%80%E6%B4%BBidea2019-3/</id>
    <published>2020-01-04T07:17:47.000Z</published>
    <updated>2023-06-20T09:15:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>　　今天突然idea不能用了，激活码无法有效激活了。看了下，原来的激活码是用在idea2019.2.3的,我升级了idea的版本到2019.3了。所以激活码不能用应该很正常。重新找了个激活的方法，以下是步骤：</p><h4 id="下载jetbrains-agent-jar"><a href="#下载jetbrains-agent-jar" class="headerlink" title="下载jetbrains-agent.jar"></a>下载jetbrains-agent.jar</h4><p><a href="https://ngpublic.anarckk.love:32443/public-static/myblog/files/2020-1/4-jetbrains-agent.jar" download="jetbrains-agent.jar">jetbrains-agent.jar</a></p><h4 id="移动jetbrains-agent-jar到安装目录"><a href="#移动jetbrains-agent-jar到安装目录" class="headerlink" title="移动jetbrains-agent.jar到安装目录"></a>移动jetbrains-agent.jar到安装目录</h4><p>　　将文件移动到 C:\Program Files\JetBrains\IntelliJ IDEA 2019.2.3\bin 路径下，这是我idea的安装目录。</p><h4 id="修改idea64-exe-vmoptions启动配置"><a href="#修改idea64-exe-vmoptions启动配置" class="headerlink" title="修改idea64.exe.vmoptions启动配置"></a>修改idea64.exe.vmoptions启动配置</h4><p>　　本来按照网上的文章，修改 C:\Program Files\JetBrains\IntelliJ IDEA 2019.2.3\bin\idea64.exe.vmoptions 文件就好，但是我修改了不生效，想起来之前一次有用到idea修改内存大小配置的，配置在这里一样不生效，狡兔三窟的配置文件竟然配置在 C:\Program Files\JetBrains\IntelliJ IDEA 2019.2.3\bin\idea.bat,里面有一段配置是这么写的:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF NOT EXIST &quot;%VM_OPTIONS_FILE%&quot; (</span><br><span class="line">  :: user-overridden</span><br><span class="line">  SET VM_OPTIONS_FILE=%USERPROFILE%\.IntelliJIdea2019.3\config\idea%BITS%.exe.vmoptions</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>所以，实际的配置文件目录在 C:\Users&lt;!–swig￼3–&gt;.IntelliJIdea2019.3\config\idea64.exe.vmoptions。在末尾添加 -javaagent:破解补丁所在的目录</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:D:\IntelliJ IDEA 2019.2.3\bin\jetbrains-agent.jar</span><br></pre></td></tr></table></figure><h4 id="修改hosts文件"><a href="#修改hosts文件" class="headerlink" title="修改hosts文件"></a>修改hosts文件</h4><p>C:\Windows\System32\drivers\etc\hosts，在末尾补上</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#idea用</span><br><span class="line">0.0.0.0 account.jetbrains.com</span><br><span class="line">0.0.0.0 www.jetbrains.com</span><br></pre></td></tr></table></figure><h4 id="激活idea"><a href="#激活idea" class="headerlink" title="激活idea"></a>激活idea</h4><p>点击Help→Register，选择License Server激活，输入 <a href="http://jetbrains-license-server/">http://jetbrains-license-server</a> ,然后点击Activate，我这张图已经激活完了，激活的时候好像还有个continue按钮。注意不要点exit。</p><style>img {    border-radius: 0 !important;}</style><p><img src="/assets/images/2020-01/04-%E6%BF%80%E6%B4%BBidea.jpg" class="lazyload" data-srcset="/assets/images/2020-01/04-%E6%BF%80%E6%B4%BBidea.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;　　今天突然idea不能用了，激活码无法有效激活了。看了下，原来的激活码是用在idea2019.2.3的,我升级了idea的版本到2019.3了。所以激活码不能用应该很正常。重新找了个激活的方法，以下是步骤：&lt;/p&gt;
&lt;h4 id=&quot;下载jetbrains-agent-ja</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="idea" scheme="https://anarckk.github.io/tags/idea/"/>
    
    <category term="idea激活" scheme="https://anarckk.github.io/tags/idea%E6%BF%80%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>visio中用手型工具拖动设计界面</title>
    <link href="https://anarckk.github.io/2020/01/02/2020-1/02-visio%E4%B8%AD%E7%94%A8%E6%89%8B%E5%9E%8B%E5%B7%A5%E5%85%B7%E6%8B%96%E5%8A%A8%E8%AE%BE%E8%AE%A1%E7%95%8C%E9%9D%A2/"/>
    <id>https://anarckk.github.io/2020/01/02/2020-1/02-visio%E4%B8%AD%E7%94%A8%E6%89%8B%E5%9E%8B%E5%B7%A5%E5%85%B7%E6%8B%96%E5%8A%A8%E8%AE%BE%E8%AE%A1%E7%95%8C%E9%9D%A2/</id>
    <published>2020-01-02T13:50:23.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>Ctrl + Alt + 左键放大 &#x2F; 右键拖动</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Ctrl + Alt + 左键放大 &amp;#x2F; 右键拖动&lt;/p&gt;
</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="visio" scheme="https://anarckk.github.io/tags/visio/"/>
    
  </entry>
  
  <entry>
    <title>接口的传统风格转向RestFul风格</title>
    <link href="https://anarckk.github.io/2019/12/31/%E5%BD%92%E6%A1%A3/restful/2019-12-31-%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%BC%A0%E7%BB%9F%E9%A3%8E%E6%A0%BC%E8%BD%AC%E5%90%91RestFul%E9%A3%8E%E6%A0%BC/"/>
    <id>https://anarckk.github.io/2019/12/31/%E5%BD%92%E6%A1%A3/restful/2019-12-31-%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%BC%A0%E7%BB%9F%E9%A3%8E%E6%A0%BC%E8%BD%AC%E5%90%91RestFul%E9%A3%8E%E6%A0%BC/</id>
    <published>2019-12-31T04:04:29.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/assets/images/2019-12/31-restful%E9%A3%8E%E6%A0%BC.jpg" class="lazyload" data-srcset="/assets/images/2019-12/31-restful%E9%A3%8E%E6%A0%BC.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>想到以前的点赞接口，如果用restful改，应该改成 &#x2F;topic&#x2F;{topicId}&#x2F;my&#x2F;zan&#x2F;{status} 。status表示我对这个topic表示赞还是不赞。</p><p>查询其他用户是否点了赞用 &#x2F;topic&#x2F;{topicId}&#x2F;{userId}&#x2F;zan</p><p>账户零钱增加x元的接口，哎，设计不出来的接口就不要抱着教条主义了，改一下，继续用 post &#x2F;account&#x2F;addMoney 也不会死。对于很难设计的动作类接口，如果可以想一个抽象名字代表就更好。不然就回归传统。</p><h4 id="对于抽象动词都表达不了的意思"><a href="#对于抽象动词都表达不了的意思" class="headerlink" title="对于抽象动词都表达不了的意思"></a>对于抽象动词都表达不了的意思</h4><p>这个接口的作用，是通知后端修复完成时间不准确的问题，所以用 &#x2F;signal&#x2F;{notice} 来表达一个信号通知接口的意思</p><blockquote><p>&#x2F;signal&#x2F;fixCompleteTime</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/assets/images/2019-12/31-restful%E9%A3%8E%E6%A0%BC.jpg&quot; class=&quot;lazyload&quot; data-srcset=&quot;/assets/images/2019-12/31-restful%E9%A3%</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="restful" scheme="https://anarckk.github.io/tags/restful/"/>
    
  </entry>
  
  <entry>
    <title>java生成图形验证码（两种图形）</title>
    <link href="https://anarckk.github.io/2019/12/31/2019-12/31-java%E7%94%9F%E6%88%90%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81%EF%BC%88%E4%B8%A4%E7%A7%8D%E5%9B%BE%E5%BD%A2%EF%BC%89/"/>
    <id>https://anarckk.github.io/2019/12/31/2019-12/31-java%E7%94%9F%E6%88%90%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81%EF%BC%88%E4%B8%A4%E7%A7%8D%E5%9B%BE%E5%BD%A2%EF%BC%89/</id>
    <published>2019-12-31T00:45:47.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>来源：<a href="https://blog.csdn.net/iku5200/article/details/91792260">https://blog.csdn.net/iku5200/article/details/91792260</a></p><p><img src="/assets/images/2019-12/31-%E6%96%B9%E5%BC%8F%E4%B8%80.jpg" class="lazyload" data-srcset="/assets/images/2019-12/31-%E6%96%B9%E5%BC%8F%E4%B8%80.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.security.sercritydemo.untils;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.awt.Color;</span><br><span class="line"><span class="keyword">import</span> java.awt.Font;</span><br><span class="line"><span class="keyword">import</span> java.awt.Graphics;</span><br><span class="line"><span class="keyword">import</span> java.awt.Graphics2D;</span><br><span class="line"><span class="keyword">import</span> java.awt.RenderingHints;</span><br><span class="line"><span class="keyword">import</span> java.awt.geom.AffineTransform;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VerifyCodeUtils</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//使用到Algerian字体，系统里没有的话需要安装字体，字体只显示大写，去掉了1,0,i,o几个容易混淆的字符</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VERIFY_CODES</span> <span class="operator">=</span> <span class="string">&quot;23456789ABCDEFGHJKLMNPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用系统默认字符源生成验证码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> verifySize 验证码长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateVerifyCode</span><span class="params">(<span class="type">int</span> verifySize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> generateVerifyCode(verifySize, VERIFY_CODES);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用指定源生成验证码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> verifySize 验证码长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sources    验证码字符源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateVerifyCode</span><span class="params">(<span class="type">int</span> verifySize, String sources)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sources == <span class="literal">null</span> || sources.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            sources = VERIFY_CODES;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">codesLen</span> <span class="operator">=</span> sources.length();</span><br><span class="line">        <span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis());</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">verifyCode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(verifySize);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; verifySize; i++) &#123;</span><br><span class="line">            verifyCode.append(sources.charAt(rand.nextInt(codesLen - <span class="number">1</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> verifyCode.toString();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成随机验证码文件,并返回验证码值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> w</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> verifySize</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">outputVerifyImage</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, File outputFile, <span class="type">int</span> verifySize)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">verifyCode</span> <span class="operator">=</span> generateVerifyCode(verifySize);</span><br><span class="line">        outputImage(w, h, outputFile, verifyCode);</span><br><span class="line">        <span class="keyword">return</span> verifyCode;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 输出随机验证码图片流,并返回验证码值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> w</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> os</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> verifySize</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">outputVerifyImage</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, OutputStream os, <span class="type">int</span> verifySize)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">verifyCode</span> <span class="operator">=</span> generateVerifyCode(verifySize);</span><br><span class="line">        outputImage(w, h, os, verifyCode);</span><br><span class="line">        <span class="keyword">return</span> verifyCode;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成指定验证码图像文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> w</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">outputImage</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, File outputFile, String code)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (outputFile == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> outputFile.getParentFile();</span><br><span class="line">        <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            outputFile.createNewFile();</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputFile);</span><br><span class="line">            outputImage(w, h, fos, code);</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 输出指定验证码图片流</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> w</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> os</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">outputImage</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, OutputStream os, String code)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">verifySize</span> <span class="operator">=</span> code.length();</span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(w, h, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        <span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">Graphics2D</span> <span class="variable">g2</span> <span class="operator">=</span> image.createGraphics();</span><br><span class="line">        g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span><br><span class="line">        Color[] colors = <span class="keyword">new</span> <span class="title class_">Color</span>[<span class="number">5</span>];</span><br><span class="line">        Color[] colorSpaces = <span class="keyword">new</span> <span class="title class_">Color</span>[]&#123;Color.WHITE, Color.CYAN,</span><br><span class="line">                Color.GRAY, Color.LIGHT_GRAY, Color.MAGENTA, Color.ORANGE,</span><br><span class="line">                Color.PINK, Color.YELLOW&#125;;</span><br><span class="line">        <span class="type">float</span>[] fractions = <span class="keyword">new</span> <span class="title class_">float</span>[colors.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; colors.length; i++) &#123;</span><br><span class="line">            colors[i] = colorSpaces[rand.nextInt(colorSpaces.length)];</span><br><span class="line">            fractions[i] = rand.nextFloat();</span><br><span class="line">        &#125;</span><br><span class="line">        Arrays.sort(fractions);</span><br><span class="line"> </span><br><span class="line">        g2.setColor(Color.GRAY);<span class="comment">// 设置边框色</span></span><br><span class="line">        g2.fillRect(<span class="number">0</span>, <span class="number">0</span>, w, h);</span><br><span class="line"> </span><br><span class="line">        <span class="type">Color</span> <span class="variable">c</span> <span class="operator">=</span> getRandColor(<span class="number">200</span>, <span class="number">250</span>);</span><br><span class="line">        g2.setColor(c);<span class="comment">// 设置背景色</span></span><br><span class="line">        g2.fillRect(<span class="number">0</span>, <span class="number">2</span>, w, h - <span class="number">4</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//绘制干扰线</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        g2.setColor(getRandColor(<span class="number">160</span>, <span class="number">200</span>));<span class="comment">// 设置线条的颜色</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> random.nextInt(w - <span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> random.nextInt(h - <span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">xl</span> <span class="operator">=</span> random.nextInt(<span class="number">6</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">yl</span> <span class="operator">=</span> random.nextInt(<span class="number">12</span>) + <span class="number">1</span>;</span><br><span class="line">            g2.drawLine(x, y, x + xl + <span class="number">40</span>, y + yl + <span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 添加噪点</span></span><br><span class="line">        <span class="type">float</span> <span class="variable">yawpRate</span> <span class="operator">=</span> <span class="number">0.05f</span>;<span class="comment">// 噪声率</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">area</span> <span class="operator">=</span> (<span class="type">int</span>) (yawpRate * w * h);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; area; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> random.nextInt(w);</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> random.nextInt(h);</span><br><span class="line">            <span class="type">int</span> <span class="variable">rgb</span> <span class="operator">=</span> getRandomIntColor();</span><br><span class="line">            image.setRGB(x, y, rgb);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        shear(g2, w, h, c);<span class="comment">// 使图片扭曲</span></span><br><span class="line"> </span><br><span class="line">        g2.setColor(getRandColor(<span class="number">100</span>, <span class="number">160</span>));</span><br><span class="line">        <span class="type">int</span> <span class="variable">fontSize</span> <span class="operator">=</span> h - <span class="number">4</span>;</span><br><span class="line">        <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Font</span>(<span class="string">&quot;Algerian&quot;</span>, Font.ITALIC, fontSize);</span><br><span class="line">        g2.setFont(font);</span><br><span class="line">        <span class="type">char</span>[] chars = code.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; verifySize; i++) &#123;</span><br><span class="line">            <span class="type">AffineTransform</span> <span class="variable">affine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AffineTransform</span>();</span><br><span class="line">            affine.setToRotation(Math.PI / <span class="number">4</span> * rand.nextDouble() * (rand.nextBoolean() ? <span class="number">1</span> : -<span class="number">1</span>), (w / verifySize) * i + fontSize / <span class="number">2</span>, h / <span class="number">2</span>);</span><br><span class="line">            g2.setTransform(affine);</span><br><span class="line">            g2.drawChars(chars, i, <span class="number">1</span>, ((w - <span class="number">10</span>) / verifySize) * i + <span class="number">5</span>, h / <span class="number">2</span> + fontSize / <span class="number">2</span> - <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        g2.dispose();</span><br><span class="line">        ImageIO.write(image, <span class="string">&quot;png&quot;</span>, os);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Color <span class="title function_">getRandColor</span><span class="params">(<span class="type">int</span> fc, <span class="type">int</span> bc)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fc &gt; <span class="number">255</span>) &#123;</span><br><span class="line">            fc = <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bc &gt; <span class="number">255</span>) &#123;</span><br><span class="line">            bc = <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">g</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color</span>(r, g, b);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getRandomIntColor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] rgb = getRandomRgb();</span><br><span class="line">        <span class="type">int</span> <span class="variable">color</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> c : rgb) &#123;</span><br><span class="line">            color = color &lt;&lt; <span class="number">8</span>;</span><br><span class="line">            color = color | c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> color;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] getRandomRgb() &#123;</span><br><span class="line">        <span class="type">int</span>[] rgb = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            rgb[i] = random.nextInt(<span class="number">255</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rgb;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shear</span><span class="params">(Graphics g, <span class="type">int</span> w1, <span class="type">int</span> h1, Color color)</span> &#123;</span><br><span class="line">        shearX(g, w1, h1, color);</span><br><span class="line">        shearY(g, w1, h1, color);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shearX</span><span class="params">(Graphics g, <span class="type">int</span> w1, <span class="type">int</span> h1, Color color)</span> &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="type">int</span> <span class="variable">period</span> <span class="operator">=</span> random.nextInt(<span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">borderGap</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">frames</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">phase</span> <span class="operator">=</span> random.nextInt(<span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; h1; i++) &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">d</span> <span class="operator">=</span> (<span class="type">double</span>) (period &gt;&gt; <span class="number">1</span>)</span><br><span class="line">                    * Math.sin((<span class="type">double</span>) i / (<span class="type">double</span>) period</span><br><span class="line">                    + (<span class="number">6.2831853071795862D</span> * (<span class="type">double</span>) phase)</span><br><span class="line">                    / (<span class="type">double</span>) frames);</span><br><span class="line">            g.copyArea(<span class="number">0</span>, i, w1, <span class="number">1</span>, (<span class="type">int</span>) d, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (borderGap) &#123;</span><br><span class="line">                g.setColor(color);</span><br><span class="line">                g.drawLine((<span class="type">int</span>) d, i, <span class="number">0</span>, i);</span><br><span class="line">                g.drawLine((<span class="type">int</span>) d + w1, i, w1, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shearY</span><span class="params">(Graphics g, <span class="type">int</span> w1, <span class="type">int</span> h1, Color color)</span> &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="type">int</span> <span class="variable">period</span> <span class="operator">=</span> random.nextInt(<span class="number">40</span>) + <span class="number">10</span>; <span class="comment">// 50;</span></span><br><span class="line"> </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">borderGap</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">frames</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">phase</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; w1; i++) &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">d</span> <span class="operator">=</span> (<span class="type">double</span>) (period &gt;&gt; <span class="number">1</span>)</span><br><span class="line">                    * Math.sin((<span class="type">double</span>) i / (<span class="type">double</span>) period</span><br><span class="line">                    + (<span class="number">6.2831853071795862D</span> * (<span class="type">double</span>) phase)</span><br><span class="line">                    / (<span class="type">double</span>) frames);</span><br><span class="line">            g.copyArea(i, <span class="number">0</span>, <span class="number">1</span>, h1, <span class="number">0</span>, (<span class="type">int</span>) d);</span><br><span class="line">            <span class="keyword">if</span> (borderGap) &#123;</span><br><span class="line">                g.setColor(color);</span><br><span class="line">                g.drawLine(i, (<span class="type">int</span>) d, i, <span class="number">0</span>);</span><br><span class="line">                g.drawLine(i, (<span class="type">int</span>) d + h1, i, h1);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:/img/&quot;</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> <span class="number">200</span>, h = <span class="number">80</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">verifyCode</span> <span class="operator">=</span> generateVerifyCode(<span class="number">4</span>);</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir, verifyCode + <span class="string">&quot;.jpg&quot;</span>);</span><br><span class="line">            outputImage(w, h, file, verifyCode);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/assets/iamges/2019-12/31-%E6%96%B9%E5%BC%8F%E4%BA%8C.jpg" class="lazyload" data-srcset="/assets/iamges/2019-12/31-%E6%96%B9%E5%BC%8F%E4%BA%8C.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.awt.Color;</span><br><span class="line"><span class="keyword">import</span> java.awt.Font;</span><br><span class="line"><span class="keyword">import</span> java.awt.Graphics;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成图形验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthImg</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"><span class="comment">// 定义图形验证码中绘制的字符的字体</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Font</span> <span class="variable">mFont</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Font</span>(<span class="string">&quot;Arial Black&quot;</span>, Font.PLAIN, <span class="number">23</span>);</span><br><span class="line"><span class="comment">// 图形验证码的大小</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">IMG_WIDTH</span> <span class="operator">=</span> <span class="number">72</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">IMG_HEIGTH</span> <span class="operator">=</span> <span class="number">27</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 获取随机颜色的方法</span></span><br><span class="line"><span class="keyword">private</span> Color <span class="title function_">getRandColor</span><span class="params">(<span class="type">int</span> fc, <span class="type">int</span> bc)</span> &#123;</span><br><span class="line"><span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"><span class="keyword">if</span> (fc &gt; <span class="number">255</span>)</span><br><span class="line">fc = <span class="number">255</span>;</span><br><span class="line"><span class="keyword">if</span> (bc &gt; <span class="number">255</span>)</span><br><span class="line">bc = <span class="number">255</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line"><span class="type">int</span> <span class="variable">g</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color</span>(r, g, b);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 获取随机字符串</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getRandomChar</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">rand</span> <span class="operator">=</span> (<span class="type">int</span>) Math.round(Math.random() * <span class="number">2</span>);</span><br><span class="line"><span class="type">long</span> <span class="variable">itmp</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> <span class="variable">ctmp</span> <span class="operator">=</span> <span class="string">&#x27;\u0000&#x27;</span>;</span><br><span class="line"><span class="keyword">switch</span> (rand) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">itmp = Math.round(Math.random() * <span class="number">25</span> + <span class="number">65</span>);</span><br><span class="line">ctmp = (<span class="type">char</span>) itmp;</span><br><span class="line"><span class="keyword">return</span> String.valueOf(ctmp);</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">itmp = Math.round(Math.random() * <span class="number">25</span> + <span class="number">97</span>);</span><br><span class="line">ctmp = (<span class="type">char</span>) itmp;</span><br><span class="line"><span class="keyword">return</span> String.valueOf(ctmp);</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">itmp = Math.round(Math.random() * <span class="number">9</span>);</span><br><span class="line"><span class="keyword">return</span> itmp + <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"><span class="comment">// 设置禁止缓存</span></span><br><span class="line">response.setHeader(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;No-cache&quot;</span>);</span><br><span class="line">response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">response.setDateHeader(<span class="string">&quot;Expires&quot;</span>, <span class="number">0</span>);</span><br><span class="line">response.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line"><span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(IMG_WIDTH, IMG_HEIGTH, BufferedImage.TYPE_INT_RGB);</span><br><span class="line"><span class="type">Graphics</span> <span class="variable">g</span> <span class="operator">=</span> image.getGraphics();</span><br><span class="line"><span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">g.setColor(getRandColor(<span class="number">200</span>, <span class="number">250</span>));</span><br><span class="line"><span class="comment">// 填充背景色</span></span><br><span class="line">g.fillRect(<span class="number">1</span>, <span class="number">1</span>, IMG_WIDTH - <span class="number">1</span>, IMG_HEIGTH - <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 为图形验证码绘制边框</span></span><br><span class="line">g.setColor(<span class="keyword">new</span> <span class="title class_">Color</span>(<span class="number">102</span>, <span class="number">102</span>, <span class="number">102</span>));</span><br><span class="line">g.drawRect(<span class="number">0</span>, <span class="number">0</span>, IMG_WIDTH, IMG_HEIGTH);</span><br><span class="line">g.setColor(getRandColor(<span class="number">160</span>, <span class="number">200</span>));</span><br><span class="line"><span class="comment">// 生成随机干扰线</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">80</span>; i++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> random.nextInt(IMG_WIDTH - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> random.nextInt(IMG_HEIGTH - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">x1</span> <span class="operator">=</span> random.nextInt(<span class="number">6</span>) + <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">y1</span> <span class="operator">=</span> random.nextInt(<span class="number">12</span>) + <span class="number">1</span>;</span><br><span class="line">g.drawLine(x, y, x + x1, y + y1);</span><br><span class="line">&#125;</span><br><span class="line">g.setColor(getRandColor(<span class="number">160</span>, <span class="number">200</span>));</span><br><span class="line"><span class="comment">// 生成随机干扰线</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">80</span>; i++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> random.nextInt(IMG_WIDTH - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> random.nextInt(IMG_HEIGTH - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">x1</span> <span class="operator">=</span> random.nextInt(<span class="number">12</span>) + <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">y1</span> <span class="operator">=</span> random.nextInt(<span class="number">6</span>) + <span class="number">1</span>;</span><br><span class="line">g.drawLine(x, y, x - x1, y - y1);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 设置绘制字符的字体</span></span><br><span class="line">g.setFont(mFont);</span><br><span class="line"><span class="comment">// 用于保存系统生成的随机字符串</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sRand</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">tmp</span> <span class="operator">=</span> getRandomChar();</span><br><span class="line">sRand += tmp;</span><br><span class="line">g.setColor(<span class="keyword">new</span> <span class="title class_">Color</span>(<span class="number">20</span> + random.nextInt(<span class="number">110</span>), <span class="number">20</span> + random.nextInt(<span class="number">110</span>), <span class="number">20</span> + random.nextInt(<span class="number">110</span>)));</span><br><span class="line">g.drawString(tmp, <span class="number">15</span> * i + <span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取HttpSession对象</span></span><br><span class="line"><span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession(<span class="literal">true</span>);</span><br><span class="line">session.removeAttribute(<span class="string">&quot;rand&quot;</span>);</span><br><span class="line">session.setAttribute(<span class="string">&quot;rand&quot;</span>, sRand);</span><br><span class="line">g.dispose();</span><br><span class="line"><span class="comment">// 向输出流中输出图片</span></span><br><span class="line">ImageIO.write(image, <span class="string">&quot;JPEG&quot;</span>, response.getOutputStream());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;来源：&lt;a href=&quot;https://blog.csdn.net/iku5200/article/details/91792260&quot;&gt;https://blog.csdn.net/iku5200/article/details/91792260&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;im</summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="JAVA" scheme="https://anarckk.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>在非SpringBean类中从ApplicationContext取出Bean</title>
    <link href="https://anarckk.github.io/2019/12/31/2019-12/31-%E5%9C%A8%E9%9D%9ESpringBean%E7%B1%BB%E4%B8%AD%E4%BB%8EApplicationContext%E5%8F%96%E5%87%BABean/"/>
    <id>https://anarckk.github.io/2019/12/31/2019-12/31-%E5%9C%A8%E9%9D%9ESpringBean%E7%B1%BB%E4%B8%AD%E4%BB%8EApplicationContext%E5%8F%96%E5%87%BABean/</id>
    <published>2019-12-31T00:40:24.000Z</published>
    <updated>2023-06-19T08:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文的主要目的是从spring中取出bean，然后赋值给一个util类，util是静态工具类，不用放到spring注册到bean。所以它也拿不到spring bean。为了让util单方面的拿到bean，可以这么做</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringContextHolder</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现ApplicationContextAware接口的context注入函数, 将其存入静态变量.</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">SpringContextHolder.applicationContext = applicationContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取得存储在静态变量中的ApplicationContext.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title function_">getApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">checkApplicationContext();</span><br><span class="line"><span class="keyword">return</span> applicationContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从静态变量ApplicationContext中取得Bean, 自动转型为所赋值对象的类型.</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(String name)</span> &#123;</span><br><span class="line">checkApplicationContext();</span><br><span class="line"><span class="keyword">return</span> (T) applicationContext.getBean(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从静态变量ApplicationContext中取得Bean, 自动转型为所赋值对象的类型.</span></span><br><span class="line"><span class="comment">// 从静态变量ApplicationContext中取得Bean, 自动转型为所赋值对象的类型.</span></span><br><span class="line"><span class="comment">// 如果有多个Bean符合Class, 取出第一个.</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">checkApplicationContext();</span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">beanMaps</span> <span class="operator">=</span> applicationContext.getBeansOfType(clazz);</span><br><span class="line"><span class="keyword">if</span> (beanMaps != <span class="literal">null</span> &amp;&amp; !beanMaps.isEmpty()) &#123;</span><br><span class="line"><span class="keyword">return</span> (T) beanMaps.values().iterator().next();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (applicationContext == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;applicaitonContext未注入,请在applicationContext.xml中定义SpringContextHolder&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过一个中介bean，在其他util中，就可以使用这个中介bean取出spring上下文中的bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; REDIS_TEMPLATE = SpringContextHolder</span><br><span class="line">        .getBean(RedisTemplate.class);</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本文的主要目的是从spring中取出bean，然后赋值给一个util类，util是静态工具类，不用放到spring注册到bean。所以它也拿不到spring bean。为了让util单方面的拿到bean，可以这么做&lt;/p&gt;
&lt;figure class=&quot;highlight </summary>
      
    
    
    
    <category term="上层技术" scheme="https://anarckk.github.io/categories/%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="JAVA" scheme="https://anarckk.github.io/tags/JAVA/"/>
    
    <category term="springframework" scheme="https://anarckk.github.io/tags/springframework/"/>
    
  </entry>
  
</feed>
